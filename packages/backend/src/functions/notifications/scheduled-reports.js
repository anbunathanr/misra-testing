"use strict";
/**
 * Scheduled Reports Lambda
 *
 * Generates and sends scheduled summary reports (daily, weekly, monthly).
 * Triggered by EventBridge cron rules.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_sqs_1 = require("@aws-sdk/client-sqs");
/**
 * Lambda handler for generating scheduled reports
 */
const handler = async (event) => {
    console.log('Starting scheduled report generation', { event });
    const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(new client_dynamodb_1.DynamoDBClient({
        region: process.env.AWS_REGION || 'us-east-1',
    }));
    const sqsClient = new client_sqs_1.SQSClient({
        region: process.env.AWS_REGION || 'us-east-1',
    });
    const testExecutionsTable = process.env.TEST_EXECUTIONS_TABLE || 'TestExecutions';
    const notificationQueueUrl = process.env.NOTIFICATION_QUEUE_URL;
    if (!notificationQueueUrl) {
        throw new Error('NOTIFICATION_QUEUE_URL environment variable is required');
    }
    // Determine report type from event rule name
    const reportType = determineReportType(event);
    const { startDate, endDate } = calculateReportPeriod(reportType);
    const { startDate: prevStartDate, endDate: prevEndDate } = calculatePreviousPeriod(reportType, startDate);
    console.log('Report period', { reportType, startDate, endDate, prevStartDate, prevEndDate });
    try {
        // Query test executions for current period
        const currentExecutions = await queryExecutions(docClient, testExecutionsTable, startDate, endDate);
        // Query test executions for previous period (for trend comparison)
        const previousExecutions = await queryExecutions(docClient, testExecutionsTable, prevStartDate, prevEndDate);
        console.log('Executions retrieved', {
            currentCount: currentExecutions.length,
            previousCount: previousExecutions.length,
        });
        // Calculate statistics
        const stats = calculateStatistics(currentExecutions);
        const previousStats = calculateStatistics(previousExecutions);
        // Calculate trends
        const trends = calculateTrends(stats, previousStats);
        // Identify top failing tests
        const topFailingTests = identifyTopFailingTests(currentExecutions);
        // Build report data
        const reportData = {
            reportType,
            period: {
                startDate,
                endDate,
            },
            stats,
            topFailingTests,
            trends,
        };
        // Publish report event to notification queue
        await publishReportEvent(sqsClient, notificationQueueUrl, reportData);
        console.log('Report generated successfully', { reportType, executionsProcessed: currentExecutions.length });
        return {
            success: true,
            reportType,
            period: {
                startDate,
                endDate,
            },
            executionsProcessed: currentExecutions.length,
        };
    }
    catch (error) {
        console.error('Error generating report', { error });
        return {
            success: false,
            reportType,
            period: {
                startDate,
                endDate,
            },
            executionsProcessed: 0,
            errorMessage: error instanceof Error ? error.message : 'Unknown error',
        };
    }
};
exports.handler = handler;
/**
 * Determine report type from EventBridge rule name
 */
function determineReportType(event) {
    const ruleName = event.resources?.[0]?.split('/')?.pop() || '';
    if (ruleName.includes('daily')) {
        return 'daily';
    }
    else if (ruleName.includes('weekly')) {
        return 'weekly';
    }
    else if (ruleName.includes('monthly')) {
        return 'monthly';
    }
    // Default to daily
    return 'daily';
}
/**
 * Calculate report period based on report type
 */
function calculateReportPeriod(reportType) {
    const now = new Date();
    const endDate = now.toISOString();
    let startDate;
    switch (reportType) {
        case 'daily':
            // Previous 24 hours
            startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            break;
        case 'weekly':
            // Previous 7 days
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        case 'monthly':
            // Previous 30 days
            startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            break;
    }
    return {
        startDate: startDate.toISOString(),
        endDate,
    };
}
/**
 * Calculate previous period for trend comparison
 */
function calculatePreviousPeriod(reportType, currentStartDate) {
    const currentStart = new Date(currentStartDate);
    let duration;
    switch (reportType) {
        case 'daily':
            duration = 24 * 60 * 60 * 1000;
            break;
        case 'weekly':
            duration = 7 * 24 * 60 * 60 * 1000;
            break;
        case 'monthly':
            duration = 30 * 24 * 60 * 60 * 1000;
            break;
    }
    const prevEndDate = new Date(currentStart.getTime());
    const prevStartDate = new Date(currentStart.getTime() - duration);
    return {
        startDate: prevStartDate.toISOString(),
        endDate: prevEndDate.toISOString(),
    };
}
/**
 * Query test executions for a time period
 */
async function queryExecutions(docClient, tableName, startDate, endDate) {
    const executions = [];
    let lastEvaluatedKey;
    do {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: tableName,
            IndexName: 'StatusTimeIndex',
            KeyConditionExpression: '#status = :status AND #createdAt BETWEEN :startDate AND :endDate',
            ExpressionAttributeNames: {
                '#status': 'status',
                '#createdAt': 'createdAt',
            },
            ExpressionAttributeValues: {
                ':status': 'completed',
                ':startDate': startDate,
                ':endDate': endDate,
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const response = await docClient.send(command);
        if (response.Items) {
            executions.push(...response.Items);
        }
        lastEvaluatedKey = response.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    return executions;
}
/**
 * Calculate summary statistics
 */
function calculateStatistics(executions) {
    if (executions.length === 0) {
        return {
            totalExecutions: 0,
            passRate: 0,
            failRate: 0,
            errorRate: 0,
            averageDuration: 0,
        };
    }
    const totalExecutions = executions.length;
    const passed = executions.filter(e => e.result === 'pass').length;
    const failed = executions.filter(e => e.result === 'fail').length;
    const errors = executions.filter(e => e.result === 'error').length;
    const totalDuration = executions.reduce((sum, e) => sum + (e.duration || 0), 0);
    const averageDuration = totalDuration / totalExecutions;
    return {
        totalExecutions,
        passRate: (passed / totalExecutions) * 100,
        failRate: (failed / totalExecutions) * 100,
        errorRate: (errors / totalExecutions) * 100,
        averageDuration: Math.round(averageDuration),
    };
}
/**
 * Calculate trends compared to previous period
 */
function calculateTrends(currentStats, previousStats) {
    let executionChange = 0;
    let passRateChange = 0;
    if (previousStats.totalExecutions > 0) {
        executionChange = ((currentStats.totalExecutions - previousStats.totalExecutions) / previousStats.totalExecutions) * 100;
    }
    if (previousStats.passRate > 0) {
        passRateChange = currentStats.passRate - previousStats.passRate;
    }
    return {
        executionChange: Math.round(executionChange * 100) / 100,
        passRateChange: Math.round(passRateChange * 100) / 100,
    };
}
/**
 * Identify top failing tests
 */
function identifyTopFailingTests(executions) {
    // Group failures by test case
    const failureMap = new Map();
    executions
        .filter(e => e.result === 'fail' || e.result === 'error')
        .forEach(e => {
        if (e.testCaseId) {
            const existing = failureMap.get(e.testCaseId);
            if (existing) {
                existing.count++;
                if (e.endTime && e.endTime > existing.lastFailure) {
                    existing.lastFailure = e.endTime;
                }
            }
            else {
                failureMap.set(e.testCaseId, {
                    count: 1,
                    lastFailure: e.endTime || e.createdAt,
                });
            }
        }
    });
    // Convert to array and sort by failure count
    const topFailing = Array.from(failureMap.entries())
        .map(([testCaseId, data]) => ({
        testCaseId,
        testName: `Test ${testCaseId.substring(0, 8)}`, // Placeholder - would need to fetch actual test name
        failureCount: data.count,
        lastFailure: data.lastFailure,
    }))
        .sort((a, b) => b.failureCount - a.failureCount)
        .slice(0, 10); // Top 10 failing tests
    return topFailing;
}
/**
 * Publish report event to notification queue
 */
async function publishReportEvent(sqsClient, queueUrl, reportData) {
    const message = {
        eventType: 'summary_report',
        eventId: `report-${Date.now()}`,
        timestamp: new Date().toISOString(),
        payload: {
            projectId: 'all', // Summary across all projects
            reportData,
            triggeredBy: 'system',
        },
    };
    const command = new client_sqs_1.SendMessageCommand({
        QueueUrl: queueUrl,
        MessageBody: JSON.stringify(message),
    });
    await sqsClient.send(command);
    console.log('Report event published to notification queue', { eventId: message.eventId });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVkLXJlcG9ydHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzY2hlZHVsZWQtcmVwb3J0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUdILDhEQUEwRDtBQUMxRCx3REFBNkU7QUFDN0Usb0RBQW9FO0FBdUNwRTs7R0FFRztBQUNJLE1BQU0sT0FBTyxHQUEwQyxLQUFLLEVBQUUsS0FBSyxFQUF5QixFQUFFO0lBQ25HLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRS9ELE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxJQUFJLGdDQUFjLENBQUM7UUFDL0QsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7S0FDOUMsQ0FBQyxDQUFDLENBQUM7SUFFSixNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUM7UUFDOUIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7S0FDOUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLGdCQUFnQixDQUFDO0lBQ2xGLE1BQU0sb0JBQW9CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQztJQUVoRSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUMxQixNQUFNLElBQUksS0FBSyxDQUFDLHlEQUF5RCxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELDZDQUE2QztJQUM3QyxNQUFNLFVBQVUsR0FBRyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QyxNQUFNLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxHQUFHLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFF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QztJQUVILE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QixPQUFPLENBQUMsR0FBRyxDQUFDLDhDQUE4QyxFQUFFLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0FBQzVGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogU2NoZWR1bGVkIFJlcG9ydHMgTGFtYmRhXHJcbiAqIFxyXG4gKiBHZW5lcmF0ZXMgYW5kIHNlbmRzIHNjaGVkdWxlZCBzdW1tYXJ5IHJlcG9ydHMgKGRhaWx5LCB3ZWVrbHksIG1vbnRobHkpLlxyXG4gKiBUcmlnZ2VyZWQgYnkgRXZlbnRCcmlkZ2UgY3JvbiBydWxlcy5cclxuICovXHJcblxyXG5pbXBvcnQgeyBIYW5kbGVyLCBTY2hlZHVsZWRFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XHJcbmltcG9ydCB7IFNRU0NsaWVudCwgU2VuZE1lc3NhZ2VDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNxcyc7XHJcbmltcG9ydCB7IFRlc3RFeGVjdXRpb24gfSBmcm9tICcuLi8uLi90eXBlcy90ZXN0LWV4ZWN1dGlvbic7XHJcblxyXG5pbnRlcmZhY2UgU3VtbWFyeVJlcG9ydERhdGEge1xyXG4gIHJlcG9ydFR5cGU6ICdkYWlseScgfCAnd2Vla2x5JyB8ICdtb250aGx5JztcclxuICBwZXJpb2Q6IHtcclxuICAgIHN0YXJ0RGF0ZTogc3RyaW5nO1xyXG4gICAgZW5kRGF0ZTogc3RyaW5nO1xyXG4gIH07XHJcbiAgc3RhdHM6IHtcclxuICAgIHRvdGFsRXhlY3V0aW9uczogbnVtYmVyO1xyXG4gICAgcGFzc1JhdGU6IG51bWJlcjtcclxuICAgIGZhaWxSYXRlOiBudW1iZXI7XHJcbiAgICBlcnJvclJhdGU6IG51bWJlcjtcclxuICAgIGF2ZXJhZ2VEdXJhdGlvbjogbnVtYmVyO1xyXG4gIH07XHJcbiAgdG9wRmFpbGluZ1Rlc3RzOiBBcnJheTx7XHJcbiAgICB0ZXN0Q2FzZUlkOiBzdHJpbmc7XHJcbiAgICB0ZXN0TmFtZTogc3RyaW5nO1xyXG4gICAgZmFpbHVyZUNvdW50OiBudW1iZXI7XHJcbiAgICBsYXN0RmFpbHVyZTogc3RyaW5nO1xyXG4gIH0+O1xyXG4gIHRyZW5kczoge1xyXG4gICAgZXhlY3V0aW9uQ2hhbmdlOiBudW1iZXI7IC8vIFBlcmNlbnRhZ2UgY2hhbmdlIGZyb20gcHJldmlvdXMgcGVyaW9kXHJcbiAgICBwYXNzUmF0ZUNoYW5nZTogbnVtYmVyO1xyXG4gIH07XHJcbn1cclxuXHJcbmludGVyZmFjZSBSZXBvcnRSZXN1bHQge1xyXG4gIHN1Y2Nlc3M6IGJvb2xlYW47XHJcbiAgcmVwb3J0VHlwZTogc3RyaW5nO1xyXG4gIHBlcmlvZDoge1xyXG4gICAgc3RhcnREYXRlOiBzdHJpbmc7XHJcbiAgICBlbmREYXRlOiBzdHJpbmc7XHJcbiAgfTtcclxuICBleGVjdXRpb25zUHJvY2Vzc2VkOiBudW1iZXI7XHJcbiAgZXJyb3JNZXNzYWdlPzogc3RyaW5nO1xyXG59XHJcblxyXG4vKipcclxuICogTGFtYmRhIGhhbmRsZXIgZm9yIGdlbmVyYXRpbmcgc2NoZWR1bGVkIHJlcG9ydHNcclxuICovXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyPFNjaGVkdWxlZEV2ZW50LCBSZXBvcnRSZXN1bHQ+ID0gYXN5bmMgKGV2ZW50KTogUHJvbWlzZTxSZXBvcnRSZXN1bHQ+ID0+IHtcclxuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgc2NoZWR1bGVkIHJlcG9ydCBnZW5lcmF0aW9uJywgeyBldmVudCB9KTtcclxuXHJcbiAgY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKG5ldyBEeW5hbW9EQkNsaWVudCh7XHJcbiAgICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXHJcbiAgfSkpO1xyXG5cclxuICBjb25zdCBzcXNDbGllbnQgPSBuZXcgU1FTQ2xpZW50KHtcclxuICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAndXMtZWFzdC0xJyxcclxuICB9KTtcclxuXHJcbiAgY29uc3QgdGVzdEV4ZWN1dGlvbnNUYWJsZSA9IHByb2Nlc3MuZW52LlRFU1RfRVhFQ1VUSU9OU19UQUJMRSB8fCAnVGVzdEV4ZWN1dGlvbnMnO1xyXG4gIGNvbnN0IG5vdGlmaWNhdGlvblF1ZXVlVXJsID0gcHJvY2Vzcy5lbnYuTk9USUZJQ0FUSU9OX1FVRVVFX1VSTDtcclxuXHJcbiAgaWYgKCFub3RpZmljYXRpb25RdWV1ZVVybCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOT1RJRklDQVRJT05fUVVFVUVfVVJMIGVudmlyb25tZW50IHZhcmlhYmxlIGlzIHJlcXVpcmVkJyk7XHJcbiAgfVxyXG5cclxuICAvLyBEZXRlcm1pbmUgcmVwb3J0IHR5cGUgZnJvbSBldmVudCBydWxlIG5hbWVcclxuICBjb25zdCByZXBvcnRUeXBlID0gZGV0ZXJtaW5lUmVwb3J0VHlwZShldmVudCk7XHJcbiAgY29uc3QgeyBzdGFydERhdGUsIGVuZERhdGUgfSA9IGNhbGN1bGF0ZVJlcG9ydFBlcmlvZChyZXBvcnRUeXBlKTtcclxuICBjb25zdCB7IHN0YXJ0RGF0ZTogcHJldlN0YXJ0RGF0ZSwgZW5kRGF0ZTogcHJldkVuZERhdGUgfSA9IGNhbGN1bGF0ZVByZXZpb3VzUGVyaW9kKHJlcG9ydFR5cGUsIHN0YXJ0RGF0ZSk7XHJcblxyXG4gIGNvbnNvbGUubG9nKCdSZXBvcnQgcGVyaW9kJywgeyByZXBvcnRUeXBlLCBzdGFydERhdGUsIGVuZERhdGUsIHByZXZTdGFydERhdGUsIHByZXZFbmREYXRlIH0pO1xyXG5cclxuICB0cnkge1xyXG4gICAgLy8gUXVlcnkgdGVzdCBleGVjdXRpb25zIGZvciBjdXJyZW50IHBlcmlvZFxyXG4gICAgY29uc3QgY3VycmVudEV4ZWN1dGlvbnMgPSBhd2FpdCBxdWVyeUV4ZWN1dGlvbnMoZG9jQ2xpZW50LCB0ZXN0RXhlY3V0aW9uc1RhYmxlLCBzdGFydERhdGUsIGVuZERhdGUpO1xyXG4gICAgXHJcbiAgICAvLyBRdWVyeSB0ZXN0IGV4ZWN1dGlvbnMgZm9yIHByZXZpb3VzIHBlcmlvZCAoZm9yIHRyZW5kIGNvbXBhcmlzb24pXHJcbiAgICBjb25zdCBwcmV2aW91c0V4ZWN1dGlvbnMgPSBhd2FpdCBxdWVyeUV4ZWN1dGlvbnMoZG9jQ2xpZW50LCB0ZXN0RXhlY3V0aW9uc1RhYmxlLCBwcmV2U3RhcnREYXRlLCBwcmV2RW5kRGF0ZSk7XHJcblxyXG4gICAgY29uc29sZS5sb2coJ0V4ZWN1dGlvbnMgcmV0cmlldmVkJywge1xyXG4gICAgICBjdXJyZW50Q291bnQ6IGN1cnJlbnRFeGVjdXRpb25zLmxlbmd0aCxcclxuICAgICAgcHJldmlvdXNDb3VudDogcHJldmlvdXNFeGVjdXRpb25zLmxlbmd0aCxcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIENhbGN1bGF0ZSBzdGF0aXN0aWNzXHJcbiAgICBjb25zdCBzdGF0cyA9IGNhbGN1bGF0ZVN0YXRpc3RpY3MoY3VycmVudEV4ZWN1dGlvbnMpO1xyXG4gICAgY29uc3QgcHJldmlvdXNTdGF0cyA9IGNhbGN1bGF0ZVN0YXRpc3RpY3MocHJldmlvdXNFeGVjdXRpb25zKTtcclxuXHJcbiAgICAvLyBDYWxjdWxhdGUgdHJlbmRzXHJcbiAgICBjb25zdCB0cmVuZHMgPSBjYWxjdWxhdGVUcmVuZHMoc3RhdHMsIHByZXZpb3VzU3RhdHMpO1xyXG5cclxuICAgIC8vIElkZW50aWZ5IHRvcCBmYWlsaW5nIHRlc3RzXHJcbiAgICBjb25zdCB0b3BGYWlsaW5nVGVzdHMgPSBpZGVudGlmeVRvcEZhaWxpbmdUZXN0cyhjdXJyZW50RXhlY3V0aW9ucyk7XHJcblxyXG4gICAgLy8gQnVpbGQgcmVwb3J0IGRhdGFcclxuICAgIGNvbnN0IHJlcG9ydERhdGE6IFN1bW1hcnlSZXBvcnREYXRhID0ge1xyXG4gICAgICByZXBvcnRUeXBlLFxyXG4gICAgICBwZXJpb2Q6IHtcclxuICAgICAgICBzdGFydERhdGUsXHJcbiAgICAgICAgZW5kRGF0ZSxcclxuICAgICAgfSxcclxuICAgICAgc3RhdHMsXHJcbiAgICAgIHRvcEZhaWxpbmdUZXN0cyxcclxuICAgICAgdHJlbmRzLFxyXG4gICAgfTtcclxuXHJcbiAgICAvLyBQdWJsaXNoIHJlcG9ydCBldmVudCB0byBub3RpZmljYXRpb24gcXVldWVcclxuICAgIGF3YWl0IHB1Ymxpc2hSZXBvcnRFdmVudChzcXNDbGllbnQsIG5vdGlmaWNhdGlvblF1ZXVlVXJsLCByZXBvcnREYXRhKTtcclxuXHJcbiAgICBjb25zb2xlLmxvZygnUmVwb3J0IGdlbmVyYXRlZCBzdWNjZXNzZnVsbHknLCB7IHJlcG9ydFR5cGUsIGV4ZWN1dGlvbnNQcm9jZXNzZWQ6IGN1cnJlbnRFeGVjdXRpb25zLmxlbmd0aCB9KTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWNjZXNzOiB0cnVlLFxyXG4gICAgICByZXBvcnRUeXBlLFxyXG4gICAgICBwZXJpb2Q6IHtcclxuICAgICAgICBzdGFydERhdGUsXHJcbiAgICAgICAgZW5kRGF0ZSxcclxuICAgICAgfSxcclxuICAgICAgZXhlY3V0aW9uc1Byb2Nlc3NlZDogY3VycmVudEV4ZWN1dGlvbnMubGVuZ3RoLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyByZXBvcnQnLCB7IGVycm9yIH0pO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIHJlcG9ydFR5cGUsXHJcbiAgICAgIHBlcmlvZDoge1xyXG4gICAgICAgIHN0YXJ0RGF0ZSxcclxuICAgICAgICBlbmREYXRlLFxyXG4gICAgICB9LFxyXG4gICAgICBleGVjdXRpb25zUHJvY2Vzc2VkOiAwLFxyXG4gICAgICBlcnJvck1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogRGV0ZXJtaW5lIHJlcG9ydCB0eXBlIGZyb20gRXZlbnRCcmlkZ2UgcnVsZSBuYW1lXHJcbiAqL1xyXG5mdW5jdGlvbiBkZXRlcm1pbmVSZXBvcnRUeXBlKGV2ZW50OiBTY2hlZHVsZWRFdmVudCk6ICdkYWlseScgfCAnd2Vla2x5JyB8ICdtb250aGx5JyB7XHJcbiAgY29uc3QgcnVsZU5hbWUgPSBldmVudC5yZXNvdXJjZXM/LlswXT8uc3BsaXQoJy8nKT8ucG9wKCkgfHwgJyc7XHJcbiAgXHJcbiAgaWYgKHJ1bGVOYW1lLmluY2x1ZGVzKCdkYWlseScpKSB7XHJcbiAgICByZXR1cm4gJ2RhaWx5JztcclxuICB9IGVsc2UgaWYgKHJ1bGVOYW1lLmluY2x1ZGVzKCd3ZWVrbHknKSkge1xyXG4gICAgcmV0dXJuICd3ZWVrbHknO1xyXG4gIH0gZWxzZSBpZiAocnVsZU5hbWUuaW5jbHVkZXMoJ21vbnRobHknKSkge1xyXG4gICAgcmV0dXJuICdtb250aGx5JztcclxuICB9XHJcbiAgXHJcbiAgLy8gRGVmYXVsdCB0byBkYWlseVxyXG4gIHJldHVybiAnZGFpbHknO1xyXG59XHJcblxyXG4vKipcclxuICogQ2FsY3VsYXRlIHJlcG9ydCBwZXJpb2QgYmFzZWQgb24gcmVwb3J0IHR5cGVcclxuICovXHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZVJlcG9ydFBlcmlvZChyZXBvcnRUeXBlOiAnZGFpbHknIHwgJ3dlZWtseScgfCAnbW9udGhseScpOiB7IHN0YXJ0RGF0ZTogc3RyaW5nOyBlbmREYXRlOiBzdHJpbmcgfSB7XHJcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcclxuICBjb25zdCBlbmREYXRlID0gbm93LnRvSVNPU3RyaW5nKCk7XHJcbiAgbGV0IHN0YXJ0RGF0ZTogRGF0ZTtcclxuXHJcbiAgc3dpdGNoIChyZXBvcnRUeXBlKSB7XHJcbiAgICBjYXNlICdkYWlseSc6XHJcbiAgICAgIC8vIFByZXZpb3VzIDI0IGhvdXJzXHJcbiAgICAgIHN0YXJ0RGF0ZSA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSAyNCAqIDYwICogNjAgKiAxMDAwKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICd3ZWVrbHknOlxyXG4gICAgICAvLyBQcmV2aW91cyA3IGRheXNcclxuICAgICAgc3RhcnREYXRlID0gbmV3IERhdGUobm93LmdldFRpbWUoKSAtIDcgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdtb250aGx5JzpcclxuICAgICAgLy8gUHJldmlvdXMgMzAgZGF5c1xyXG4gICAgICBzdGFydERhdGUgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKTtcclxuICAgICAgYnJlYWs7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgc3RhcnREYXRlOiBzdGFydERhdGUudG9JU09TdHJpbmcoKSxcclxuICAgIGVuZERhdGUsXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZSBwcmV2aW91cyBwZXJpb2QgZm9yIHRyZW5kIGNvbXBhcmlzb25cclxuICovXHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZVByZXZpb3VzUGVyaW9kKFxyXG4gIHJlcG9ydFR5cGU6ICdkYWlseScgfCAnd2Vla2x5JyB8ICdtb250aGx5JyxcclxuICBjdXJyZW50U3RhcnREYXRlOiBzdHJpbmdcclxuKTogeyBzdGFydERhdGU6IHN0cmluZzsgZW5kRGF0ZTogc3RyaW5nIH0ge1xyXG4gIGNvbnN0IGN1cnJlbnRTdGFydCA9IG5ldyBEYXRlKGN1cnJlbnRTdGFydERhdGUpO1xyXG4gIGxldCBkdXJhdGlvbjogbnVtYmVyO1xyXG5cclxuICBzd2l0Y2ggKHJlcG9ydFR5cGUpIHtcclxuICAgIGNhc2UgJ2RhaWx5JzpcclxuICAgICAgZHVyYXRpb24gPSAyNCAqIDYwICogNjAgKiAxMDAwO1xyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UgJ3dlZWtseSc6XHJcbiAgICAgIGR1cmF0aW9uID0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDA7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnbW9udGhseSc6XHJcbiAgICAgIGR1cmF0aW9uID0gMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwO1xyXG4gICAgICBicmVhaztcclxuICB9XHJcblxyXG4gIGNvbnN0IHByZXZFbmREYXRlID0gbmV3IERhdGUoY3VycmVudFN0YXJ0LmdldFRpbWUoKSk7XHJcbiAgY29uc3QgcHJldlN0YXJ0RGF0ZSA9IG5ldyBEYXRlKGN1cnJlbnRTdGFydC5nZXRUaW1lKCkgLSBkdXJhdGlvbik7XHJcblxyXG4gIHJldHVybiB7XHJcbiAgICBzdGFydERhdGU6IHByZXZTdGFydERhdGUudG9JU09TdHJpbmcoKSxcclxuICAgIGVuZERhdGU6IHByZXZFbmREYXRlLnRvSVNPU3RyaW5nKCksXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFF1ZXJ5IHRlc3QgZXhlY3V0aW9ucyBmb3IgYSB0aW1lIHBlcmlvZFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcXVlcnlFeGVjdXRpb25zKFxyXG4gIGRvY0NsaWVudDogRHluYW1vREJEb2N1bWVudENsaWVudCxcclxuICB0YWJsZU5hbWU6IHN0cmluZyxcclxuICBzdGFydERhdGU6IHN0cmluZyxcclxuICBlbmREYXRlOiBzdHJpbmdcclxuKTogUHJvbWlzZTxUZXN0RXhlY3V0aW9uW10+IHtcclxuICBjb25zdCBleGVjdXRpb25zOiBUZXN0RXhlY3V0aW9uW10gPSBbXTtcclxuICBsZXQgbGFzdEV2YWx1YXRlZEtleTogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZDtcclxuXHJcbiAgZG8ge1xyXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcclxuICAgICAgSW5kZXhOYW1lOiAnU3RhdHVzVGltZUluZGV4JyxcclxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNzdGF0dXMgPSA6c3RhdHVzIEFORCAjY3JlYXRlZEF0IEJFVFdFRU4gOnN0YXJ0RGF0ZSBBTkQgOmVuZERhdGUnLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcclxuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnLFxyXG4gICAgICAgICcjY3JlYXRlZEF0JzogJ2NyZWF0ZWRBdCcsXHJcbiAgICAgIH0sXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAnOnN0YXR1cyc6ICdjb21wbGV0ZWQnLFxyXG4gICAgICAgICc6c3RhcnREYXRlJzogc3RhcnREYXRlLFxyXG4gICAgICAgICc6ZW5kRGF0ZSc6IGVuZERhdGUsXHJcbiAgICAgIH0sXHJcbiAgICAgIEV4Y2x1c2l2ZVN0YXJ0S2V5OiBsYXN0RXZhbHVhdGVkS2V5LFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcclxuXHJcbiAgICBpZiAocmVzcG9uc2UuSXRlbXMpIHtcclxuICAgICAgZXhlY3V0aW9ucy5wdXNoKC4uLihyZXNwb25zZS5JdGVtcyBhcyBUZXN0RXhlY3V0aW9uW10pKTtcclxuICAgIH1cclxuXHJcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleTtcclxuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcclxuXHJcbiAgcmV0dXJuIGV4ZWN1dGlvbnM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGUgc3VtbWFyeSBzdGF0aXN0aWNzXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVTdGF0aXN0aWNzKGV4ZWN1dGlvbnM6IFRlc3RFeGVjdXRpb25bXSk6IHtcclxuICB0b3RhbEV4ZWN1dGlvbnM6IG51bWJlcjtcclxuICBwYXNzUmF0ZTogbnVtYmVyO1xyXG4gIGZhaWxSYXRlOiBudW1iZXI7XHJcbiAgZXJyb3JSYXRlOiBudW1iZXI7XHJcbiAgYXZlcmFnZUR1cmF0aW9uOiBudW1iZXI7XHJcbn0ge1xyXG4gIGlmIChleGVjdXRpb25zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdG90YWxFeGVjdXRpb25zOiAwLFxyXG4gICAgICBwYXNzUmF0ZTogMCxcclxuICAgICAgZmFpbFJhdGU6IDAsXHJcbiAgICAgIGVycm9yUmF0ZTogMCxcclxuICAgICAgYXZlcmFnZUR1cmF0aW9uOiAwLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHRvdGFsRXhlY3V0aW9ucyA9IGV4ZWN1dGlvbnMubGVuZ3RoO1xyXG4gIGNvbnN0IHBhc3NlZCA9IGV4ZWN1dGlvbnMuZmlsdGVyKGUgPT4gZS5yZXN1bHQgPT09ICdwYXNzJykubGVuZ3RoO1xyXG4gIGNvbnN0IGZhaWxlZCA9IGV4ZWN1dGlvbnMuZmlsdGVyKGUgPT4gZS5yZXN1bHQgPT09ICdmYWlsJykubGVuZ3RoO1xyXG4gIGNvbnN0IGVycm9ycyA9IGV4ZWN1dGlvbnMuZmlsdGVyKGUgPT4gZS5yZXN1bHQgPT09ICdlcnJvcicpLmxlbmd0aDtcclxuXHJcbiAgY29uc3QgdG90YWxEdXJhdGlvbiA9IGV4ZWN1dGlvbnMucmVkdWNlKChzdW0sIGUpID0+IHN1bSArIChlLmR1cmF0aW9uIHx8IDApLCAwKTtcclxuICBjb25zdCBhdmVyYWdlRHVyYXRpb24gPSB0b3RhbER1cmF0aW9uIC8gdG90YWxFeGVjdXRpb25zO1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgdG90YWxFeGVjdXRpb25zLFxyXG4gICAgcGFzc1JhdGU6IChwYXNzZWQgLyB0b3RhbEV4ZWN1dGlvbnMpICogMTAwLFxyXG4gICAgZmFpbFJhdGU6IChmYWlsZWQgLyB0b3RhbEV4ZWN1dGlvbnMpICogMTAwLFxyXG4gICAgZXJyb3JSYXRlOiAoZXJyb3JzIC8gdG90YWxFeGVjdXRpb25zKSAqIDEwMCxcclxuICAgIGF2ZXJhZ2VEdXJhdGlvbjogTWF0aC5yb3VuZChhdmVyYWdlRHVyYXRpb24pLFxyXG4gIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGUgdHJlbmRzIGNvbXBhcmVkIHRvIHByZXZpb3VzIHBlcmlvZFxyXG4gKi9cclxuZnVuY3Rpb24gY2FsY3VsYXRlVHJlbmRzKFxyXG4gIGN1cnJlbnRTdGF0czogeyB0b3RhbEV4ZWN1dGlvbnM6IG51bWJlcjsgcGFzc1JhdGU6IG51bWJlciB9LFxyXG4gIHByZXZpb3VzU3RhdHM6IHsgdG90YWxFeGVjdXRpb25zOiBudW1iZXI7IHBhc3NSYXRlOiBudW1iZXIgfVxyXG4pOiB7XHJcbiAgZXhlY3V0aW9uQ2hhbmdlOiBudW1iZXI7XHJcbiAgcGFzc1JhdGVDaGFuZ2U6IG51bWJlcjtcclxufSB7XHJcbiAgbGV0IGV4ZWN1dGlvbkNoYW5nZSA9IDA7XHJcbiAgbGV0IHBhc3NSYXRlQ2hhbmdlID0gMDtcclxuXHJcbiAgaWYgKHByZXZpb3VzU3RhdHMudG90YWxFeGVjdXRpb25zID4gMCkge1xyXG4gICAgZXhlY3V0aW9uQ2hhbmdlID0gKChjdXJyZW50U3RhdHMudG90YWxFeGVjdXRpb25zIC0gcHJldmlvdXNTdGF0cy50b3RhbEV4ZWN1dGlvbnMpIC8gcHJldmlvdXNTdGF0cy50b3RhbEV4ZWN1dGlvbnMpICogMTAwO1xyXG4gIH1cclxuXHJcbiAgaWYgKHByZXZpb3VzU3RhdHMucGFzc1JhdGUgPiAwKSB7XHJcbiAgICBwYXNzUmF0ZUNoYW5nZSA9IGN1cnJlbnRTdGF0cy5wYXNzUmF0ZSAtIHByZXZpb3VzU3RhdHMucGFzc1JhdGU7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgZXhlY3V0aW9uQ2hhbmdlOiBNYXRoLnJvdW5kKGV4ZWN1dGlvbkNoYW5nZSAqIDEwMCkgLyAxMDAsXHJcbiAgICBwYXNzUmF0ZUNoYW5nZTogTWF0aC5yb3VuZChwYXNzUmF0ZUNoYW5nZSAqIDEwMCkgLyAxMDAsXHJcbiAgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIElkZW50aWZ5IHRvcCBmYWlsaW5nIHRlc3RzXHJcbiAqL1xyXG5mdW5jdGlvbiBpZGVudGlmeVRvcEZhaWxpbmdUZXN0cyhleGVjdXRpb25zOiBUZXN0RXhlY3V0aW9uW10pOiBBcnJheTx7XHJcbiAgdGVzdENhc2VJZDogc3RyaW5nO1xyXG4gIHRlc3ROYW1lOiBzdHJpbmc7XHJcbiAgZmFpbHVyZUNvdW50OiBudW1iZXI7XHJcbiAgbGFzdEZhaWx1cmU6IHN0cmluZztcclxufT4ge1xyXG4gIC8vIEdyb3VwIGZhaWx1cmVzIGJ5IHRlc3QgY2FzZVxyXG4gIGNvbnN0IGZhaWx1cmVNYXAgPSBuZXcgTWFwPHN0cmluZywgeyBjb3VudDogbnVtYmVyOyBsYXN0RmFpbHVyZTogc3RyaW5nIH0+KCk7XHJcblxyXG4gIGV4ZWN1dGlvbnNcclxuICAgIC5maWx0ZXIoZSA9PiBlLnJlc3VsdCA9PT0gJ2ZhaWwnIHx8IGUucmVzdWx0ID09PSAnZXJyb3InKVxyXG4gICAgLmZvckVhY2goZSA9PiB7XHJcbiAgICAgIGlmIChlLnRlc3RDYXNlSWQpIHtcclxuICAgICAgICBjb25zdCBleGlzdGluZyA9IGZhaWx1cmVNYXAuZ2V0KGUudGVzdENhc2VJZCk7XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XHJcbiAgICAgICAgICBleGlzdGluZy5jb3VudCsrO1xyXG4gICAgICAgICAgaWYgKGUuZW5kVGltZSAmJiBlLmVuZFRpbWUgPiBleGlzdGluZy5sYXN0RmFpbHVyZSkge1xyXG4gICAgICAgICAgICBleGlzdGluZy5sYXN0RmFpbHVyZSA9IGUuZW5kVGltZTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZmFpbHVyZU1hcC5zZXQoZS50ZXN0Q2FzZUlkLCB7XHJcbiAgICAgICAgICAgIGNvdW50OiAxLFxyXG4gICAgICAgICAgICBsYXN0RmFpbHVyZTogZS5lbmRUaW1lIHx8IGUuY3JlYXRlZEF0LFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgLy8gQ29udmVydCB0byBhcnJheSBhbmQgc29ydCBieSBmYWlsdXJlIGNvdW50XHJcbiAgY29uc3QgdG9wRmFpbGluZyA9IEFycmF5LmZyb20oZmFpbHVyZU1hcC5lbnRyaWVzKCkpXHJcbiAgICAubWFwKChbdGVzdENhc2VJZCwgZGF0YV0pID0+ICh7XHJcbiAgICAgIHRlc3RDYXNlSWQsXHJcbiAgICAgIHRlc3ROYW1lOiBgVGVzdCAke3Rlc3RDYXNlSWQuc3Vic3RyaW5nKDAsIDgpfWAsIC8vIFBsYWNlaG9sZGVyIC0gd291bGQgbmVlZCB0byBmZXRjaCBhY3R1YWwgdGVzdCBuYW1lXHJcbiAgICAgIGZhaWx1cmVDb3VudDogZGF0YS5jb3VudCxcclxuICAgICAgbGFzdEZhaWx1cmU6IGRhdGEubGFzdEZhaWx1cmUsXHJcbiAgICB9KSlcclxuICAgIC5zb3J0KChhLCBiKSA9PiBiLmZhaWx1cmVDb3VudCAtIGEuZmFpbHVyZUNvdW50KVxyXG4gICAgLnNsaWNlKDAsIDEwKTsgLy8gVG9wIDEwIGZhaWxpbmcgdGVzdHNcclxuXHJcbiAgcmV0dXJuIHRvcEZhaWxpbmc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBQdWJsaXNoIHJlcG9ydCBldmVudCB0byBub3RpZmljYXRpb24gcXVldWVcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHB1Ymxpc2hSZXBvcnRFdmVudChcclxuICBzcXNDbGllbnQ6IFNRU0NsaWVudCxcclxuICBxdWV1ZVVybDogc3RyaW5nLFxyXG4gIHJlcG9ydERhdGE6IFN1bW1hcnlSZXBvcnREYXRhXHJcbik6IFByb21pc2U8dm9pZD4ge1xyXG4gIGNvbnN0IG1lc3NhZ2UgPSB7XHJcbiAgICBldmVudFR5cGU6ICdzdW1tYXJ5X3JlcG9ydCcsXHJcbiAgICBldmVudElkOiBgcmVwb3J0LSR7RGF0ZS5ub3coKX1gLFxyXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICBwYXlsb2FkOiB7XHJcbiAgICAgIHByb2plY3RJZDogJ2FsbCcsIC8vIFN1bW1hcnkgYWNyb3NzIGFsbCBwcm9qZWN0c1xyXG4gICAgICByZXBvcnREYXRhLFxyXG4gICAgICB0cmlnZ2VyZWRCeTogJ3N5c3RlbScsXHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2VuZE1lc3NhZ2VDb21tYW5kKHtcclxuICAgIFF1ZXVlVXJsOiBxdWV1ZVVybCxcclxuICAgIE1lc3NhZ2VCb2R5OiBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSxcclxuICB9KTtcclxuXHJcbiAgYXdhaXQgc3FzQ2xpZW50LnNlbmQoY29tbWFuZCk7XHJcbiAgY29uc29sZS5sb2coJ1JlcG9ydCBldmVudCBwdWJsaXNoZWQgdG8gbm90aWZpY2F0aW9uIHF1ZXVlJywgeyBldmVudElkOiBtZXNzYWdlLmV2ZW50SWQgfSk7XHJcbn1cclxuIl19