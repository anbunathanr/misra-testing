"use strict";
/**
 * Property-based tests for CRUD operations
 * Tests Properties 1, 4, and 13 from the design document
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const fc = __importStar(require("fast-check"));
const file_metadata_service_1 = require("../../services/file-metadata-service");
const dynamodb_client_1 = require("../../database/dynamodb-client");
const file_metadata_generators_1 = require("../generators/file-metadata-generators");
describe('CRUD Operations Properties', () => {
    let service;
    let dbClient;
    const createdFileIds = [];
    beforeAll(() => {
        dbClient = new dynamodb_client_1.DynamoDBClientWrapper('test');
        service = new file_metadata_service_1.FileMetadataService(dbClient);
    });
    afterEach(async () => {
        for (const fileId of createdFileIds) {
            try {
                const metadata = await service.getFileMetadata(fileId);
                if (metadata) {
                    await service.deleteFileMetadata(fileId, metadata.user_id);
                }
            }
            catch (error) {
                // Ignore errors during cleanup
            }
        }
        createdFileIds.length = 0;
    });
    afterAll(async () => {
        await dbClient.close();
    });
    /**
     * **Validates: Requirements 1.1, 1.2, 4.1, 4.4**
     */
    test('Property 1: File metadata storage completeness', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), async (metadata) => {
            createdFileIds.push(metadata.file_id);
            const created = await service.createFileMetadata(metadata);
            const retrieved = await service.getFileMetadata(metadata.file_id);
            expect(retrieved).not.toBeNull();
            expect(retrieved?.file_id).toBe(metadata.file_id);
            expect(retrieved?.user_id).toBe(metadata.user_id);
            expect(retrieved?.filename).toBe(metadata.filename);
            expect(retrieved?.file_type).toBe(metadata.file_type);
            expect(retrieved?.file_size).toBe(metadata.file_size);
            expect(retrieved?.upload_timestamp).toBe(metadata.upload_timestamp);
            expect(retrieved?.analysis_status).toBe(metadata.analysis_status);
            expect(retrieved?.s3_key).toBe(metadata.s3_key);
            expect(retrieved?.created_at).toBe(metadata.created_at);
            expect(retrieved?.updated_at).toBe(metadata.updated_at);
            if (metadata.analysis_results) {
                expect(retrieved?.analysis_results).toEqual(metadata.analysis_results);
            }
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 4.1**
     */
    test('Property 4: Single file retrieval accuracy', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), async (metadata) => {
            createdFileIds.push(metadata.file_id);
            await service.createFileMetadata(metadata);
            const retrieved = await service.getFileMetadata(metadata.file_id);
            expect(retrieved).not.toBeNull();
            expect(retrieved).toEqual(metadata);
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 6.1**
     */
    test('Property 13: Complete deletion', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), async (metadata) => {
            await service.createFileMetadata(metadata);
            const beforeDelete = await service.getFileMetadata(metadata.file_id);
            expect(beforeDelete).not.toBeNull();
            await service.deleteFileMetadata(metadata.file_id, metadata.user_id);
            const afterDelete = await service.getFileMetadata(metadata.file_id);
            expect(afterDelete).toBeNull();
            const index = createdFileIds.indexOf(metadata.file_id);
            if (index > -1) {
                createdFileIds.splice(index, 1);
            }
        }), { numRuns: 100 });
    });
    test('Property 13 (edge case): Deletion of non-existent file throws error', async () => {
        await fc.assert(fc.asyncProperty(fc.uuid(), fc.string({ minLength: 1, maxLength: 50 }), async (fileId, userId) => {
            await expect(service.deleteFileMetadata(fileId, userId)).rejects.toThrow('File not found');
        }), { numRuns: 100 });
    });
    test('Property 13 (edge case): Deletion fails for non-owner', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), fc.string({ minLength: 1, maxLength: 50 }), async (metadata, differentUserId) => {
            fc.pre(differentUserId !== metadata.user_id);
            createdFileIds.push(metadata.file_id);
            await service.createFileMetadata(metadata);
            await expect(service.deleteFileMetadata(metadata.file_id, differentUserId)).rejects.toThrow('Unauthorized');
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 1.4**
     */
    test('Property 2: File ID uniqueness enforcement', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), async (metadata) => {
            createdFileIds.push(metadata.file_id);
            await service.createFileMetadata(metadata);
            await expect(service.createFileMetadata(metadata)).rejects.toThrow();
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 1.5**
     */
    test('Property 3: Automatic timestamp generation', async () => {
        await fc.assert(fc.asyncProperty((0, file_metadata_generators_1.fileMetadataGenerator)(), async (metadata) => {
            createdFileIds.push(metadata.file_id);
            const beforeTimestamp = Math.floor(Date.now() / 1000);
            const created = await service.createFileMetadata(metadata);
            const afterTimestamp = Math.floor(Date.now() / 1000);
            expect(created.upload_timestamp).toBeGreaterThanOrEqual(beforeTimestamp - 1);
            expect(created.upload_timestamp).toBeLessThanOrEqual(afterTimestamp + 1);
            expect(created.created_at).toBeGreaterThanOrEqual(beforeTimestamp * 1000 - 1000);
            expect(created.created_at).toBeLessThanOrEqual(afterTimestamp * 1000 + 1000);
            expect(created.updated_at).toBeGreaterThanOrEqual(beforeTimestamp * 1000 - 1000);
            expect(created.updated_at).toBeLessThanOrEqual(afterTimestamp * 1000 + 1000);
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 4.2, 5.3, 6.3**
     */
    test('Property 5: Non-existent file error handling', async () => {
        await fc.assert(fc.asyncProperty(fc.uuid(), async (nonExistentFileId) => {
            const result = await service.getFileMetadata(nonExistentFileId);
            expect(result).toBeNull();
            await expect(service.updateFileMetadata(nonExistentFileId, { analysis_status: 'completed' })).rejects.toThrow('File not found');
            await expect(service.deleteFileMetadata(nonExistentFileId, 'some-user-id')).rejects.toThrow('File not found');
        }), { numRuns: 100 });
    });
    /**
     * **Validates: Requirements 4.3, 6.4, 6.5**
     */
    test('Property 15: Batch operation consistency', async () => {
        await fc.assert(fc.asyncProperty(fc.array((0, file_metadata_generators_1.fileMetadataGenerator)(), { minLength: 2, maxLength: 10 }), async (metadataArray) => {
            metadataArray.forEach(m => createdFileIds.push(m.file_id));
            await Promise.all(metadataArray.map(metadata => service.createFileMetadata(metadata)));
            const fileIds = metadataArray.map(m => m.file_id);
            const batchResults = await service.batchGetFiles(fileIds);
            expect(batchResults.length).toBe(metadataArray.length);
            const resultIds = batchResults.map(r => r.file_id);
            fileIds.forEach(id => {
                expect(resultIds).toContain(id);
            });
            batchResults.forEach(result => {
                const original = metadataArray.find(m => m.file_id === result.file_id);
                expect(original).toBeDefined();
                expect(result).toEqual(original);
            });
        }), { numRuns: 50 });
    });
    test('Property 15 (edge case): Batch get with non-existent files', async () => {
        await fc.assert(fc.asyncProperty(fc.array((0, file_metadata_generators_1.fileMetadataGenerator)(), { minLength: 2, maxLength: 5 }), fc.array(fc.uuid(), { minLength: 2, maxLength: 5 }), async (existingMetadata, nonExistentIds) => {
            existingMetadata.forEach(m => createdFileIds.push(m.file_id));
            await Promise.all(existingMetadata.map(metadata => service.createFileMetadata(metadata)));
            const allIds = [
                ...existingMetadata.map(m => m.file_id),
                ...nonExistentIds
            ];
            const results = await service.batchGetFiles(allIds);
            expect(results.length).toBe(existingMetadata.length);
            const existingIds = existingMetadata.map(m => m.file_id);
            results.forEach(result => {
                expect(existingIds).toContain(result.file_id);
            });
        }), { numRuns: 50 });
    });
    test('Property 15 (edge case): Batch get with empty array', async () => {
        const results = await service.batchGetFiles([]);
        expect(results).toEqual([]);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J1ZC1vcGVyYXRpb25zLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjcnVkLW9wZXJhdGlvbnMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVILCtDQUFnQztBQUNoQyxnRkFBMEU7QUFDMUUsb0VBQXNFO0FBQ3RFLHFGQUE4RTtBQUc5RSxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQzFDLElBQUksT0FBNEIsQ0FBQTtJQUNoQyxJQUFJLFFBQStCLENBQUE7SUFDbkMsTUFBTSxjQUFjLEdBQWEsRUFBRSxDQUFBO0lBRW5DLFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixRQUFRLEdBQUcsSUFBSSx1Q0FBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUM1QyxPQUFPLEdBQUcsSUFBSSwyQ0FBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUM3QyxDQUFDLENBQUMsQ0FBQTtJQUVGLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixLQUFLLE1BQU0sTUFBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ3BDLElBQUksQ0FBQztnQkFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQ3RELElBQUksUUFBUSxFQUFFLENBQUM7b0JBQ2IsTUFBTSxPQUFPLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDNUQsQ0FBQztZQUNILENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLCtCQUErQjtZQUNqQyxDQUFDO1FBQ0gsQ0FBQztRQUNELGNBQWMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO0lBQzNCLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ2xCLE1BQU0sUUFB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LENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQy9DLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDN0IsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBQcm9wZXJ0eS1iYXNlZCB0ZXN0cyBmb3IgQ1JVRCBvcGVyYXRpb25zXHJcbiAqIFRlc3RzIFByb3BlcnRpZXMgMSwgNCwgYW5kIDEzIGZyb20gdGhlIGRlc2lnbiBkb2N1bWVudFxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGZjIGZyb20gJ2Zhc3QtY2hlY2snXHJcbmltcG9ydCB7IEZpbGVNZXRhZGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9maWxlLW1ldGFkYXRhLXNlcnZpY2UnXHJcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50V3JhcHBlciB9IGZyb20gJy4uLy4uL2RhdGFiYXNlL2R5bmFtb2RiLWNsaWVudCdcclxuaW1wb3J0IHsgZmlsZU1ldGFkYXRhR2VuZXJhdG9yIH0gZnJvbSAnLi4vZ2VuZXJhdG9ycy9maWxlLW1ldGFkYXRhLWdlbmVyYXRvcnMnXHJcbmltcG9ydCB7IEZpbGVNZXRhZGF0YSB9IGZyb20gJy4uLy4uL3R5cGVzL2ZpbGUtbWV0YWRhdGEnXHJcblxyXG5kZXNjcmliZSgnQ1JVRCBPcGVyYXRpb25zIFByb3BlcnRpZXMnLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IEZpbGVNZXRhZGF0YVNlcnZpY2VcclxuICBsZXQgZGJDbGllbnQ6IER5bmFtb0RCQ2xpZW50V3JhcHBlclxyXG4gIGNvbnN0IGNyZWF0ZWRGaWxlSWRzOiBzdHJpbmdbXSA9IFtdXHJcblxyXG4gIGJlZm9yZUFsbCgoKSA9PiB7XHJcbiAgICBkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudFdyYXBwZXIoJ3Rlc3QnKVxyXG4gICAgc2VydmljZSA9IG5ldyBGaWxlTWV0YWRhdGFTZXJ2aWNlKGRiQ2xpZW50KVxyXG4gIH0pXHJcblxyXG4gIGFmdGVyRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBmb3IgKGNvbnN0IGZpbGVJZCBvZiBjcmVhdGVkRmlsZUlkcykge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgc2VydmljZS5nZXRGaWxlTWV0YWRhdGEoZmlsZUlkKVxyXG4gICAgICAgIGlmIChtZXRhZGF0YSkge1xyXG4gICAgICAgICAgYXdhaXQgc2VydmljZS5kZWxldGVGaWxlTWV0YWRhdGEoZmlsZUlkLCBtZXRhZGF0YS51c2VyX2lkKVxyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAvLyBJZ25vcmUgZXJyb3JzIGR1cmluZyBjbGVhbnVwXHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNyZWF0ZWRGaWxlSWRzLmxlbmd0aCA9IDBcclxuICB9KVxyXG5cclxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBkYkNsaWVudC5jbG9zZSgpXHJcbiAgfSlcclxuXHJcbiAgLyoqXHJcbiAgICogKipWYWxpZGF0ZXM6IFJlcXVpcmVtZW50cyAxLjEsIDEuMiwgNC4xLCA0LjQqKlxyXG4gICAqL1xyXG4gIHRlc3QoJ1Byb3BlcnR5IDE6IEZpbGUgbWV0YWRhdGEgc3RvcmFnZSBjb21wbGV0ZW5lc3MnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBmYy5hc3NlcnQoXHJcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoZmlsZU1ldGFkYXRhR2VuZXJhdG9yKCksIGFzeW5jIChtZXRhZGF0YTogRmlsZU1ldGFkYXRhKSA9PiB7XHJcbiAgICAgICAgY3JlYXRlZEZpbGVJZHMucHVzaChtZXRhZGF0YS5maWxlX2lkKVxyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVkID0gYXdhaXQgc2VydmljZS5jcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGEpXHJcbiAgICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgc2VydmljZS5nZXRGaWxlTWV0YWRhdGEobWV0YWRhdGEuZmlsZV9pZClcclxuXHJcbiAgICAgICAgZXhwZWN0KHJldHJpZXZlZCkubm90LnRvQmVOdWxsKClcclxuICAgICAgICBleHBlY3QocmV0cmlldmVkPy5maWxlX2lkKS50b0JlKG1ldGFkYXRhLmZpbGVfaWQpXHJcbiAgICAgICAgZXhwZWN0KHJldHJpZXZlZD8udXNlcl9pZCkudG9CZShtZXRhZGF0YS51c2VyX2lkKVxyXG4gICAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LmZpbGVuYW1lKS50b0JlKG1ldGFkYXRhLmZpbGVuYW1lKVxyXG4gICAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LmZpbGVfdHlwZSkudG9CZShtZXRhZGF0YS5maWxlX3R5cGUpXHJcbiAgICAgICAgZXhwZWN0KHJldHJpZXZlZD8uZmlsZV9zaXplKS50b0JlKG1ldGFkYXRhLmZpbGVfc2l6ZSlcclxuICAgICAgICBleHBlY3QocmV0cmlldmVkPy51cGxvYWRfdGltZXN0YW1wKS50b0JlKG1ldGFkYXRhLnVwbG9hZF90aW1lc3RhbXApXHJcbiAgICAgICAgZXhwZWN0KHJldHJpZXZlZD8uYW5hbHlzaXNfc3RhdHVzKS50b0JlKG1ldGFkYXRhLmFuYWx5c2lzX3N0YXR1cylcclxuICAgICAgICBleHBlY3QocmV0cmlldmVkPy5zM19rZXkpLnRvQmUobWV0YWRhdGEuczNfa2V5KVxyXG4gICAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LmNyZWF0ZWRfYXQpLnRvQmUobWV0YWRhdGEuY3JlYXRlZF9hdClcclxuICAgICAgICBleHBlY3QocmV0cmlldmVkPy51cGRhdGVkX2F0KS50b0JlKG1ldGFkYXRhLnVwZGF0ZWRfYXQpXHJcblxyXG4gICAgICAgIGlmIChtZXRhZGF0YS5hbmFseXNpc19yZXN1bHRzKSB7XHJcbiAgICAgICAgICBleHBlY3QocmV0cmlldmVkPy5hbmFseXNpc19yZXN1bHRzKS50b0VxdWFsKG1ldGFkYXRhLmFuYWx5c2lzX3Jlc3VsdHMpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgeyBudW1SdW5zOiAxMDAgfVxyXG4gICAgKVxyXG4gIH0pXHJcblxyXG4gIC8qKlxyXG4gICAqICoqVmFsaWRhdGVzOiBSZXF1aXJlbWVudHMgNC4xKipcclxuICAgKi9cclxuICB0ZXN0KCdQcm9wZXJ0eSA0OiBTaW5nbGUgZmlsZSByZXRyaWV2YWwgYWNjdXJhY3knLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBmYy5hc3NlcnQoXHJcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoZmlsZU1ldGFkYXRhR2VuZXJhdG9yKCksIGFzeW5jIChtZXRhZGF0YTogRmlsZU1ldGFkYXRhKSA9PiB7XHJcbiAgICAgICAgY3JlYXRlZEZpbGVJZHMucHVzaChtZXRhZGF0YS5maWxlX2lkKVxyXG5cclxuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZUZpbGVNZXRhZGF0YShtZXRhZGF0YSlcclxuICAgICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBzZXJ2aWNlLmdldEZpbGVNZXRhZGF0YShtZXRhZGF0YS5maWxlX2lkKVxyXG5cclxuICAgICAgICBleHBlY3QocmV0cmlldmVkKS5ub3QudG9CZU51bGwoKVxyXG4gICAgICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvRXF1YWwobWV0YWRhdGEpXHJcbiAgICAgIH0pLFxyXG4gICAgICB7IG51bVJ1bnM6IDEwMCB9XHJcbiAgICApXHJcbiAgfSlcclxuXHJcbiAgLyoqXHJcbiAgICogKipWYWxpZGF0ZXM6IFJlcXVpcmVtZW50cyA2LjEqKlxyXG4gICAqL1xyXG4gIHRlc3QoJ1Byb3BlcnR5IDEzOiBDb21wbGV0ZSBkZWxldGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgIGF3YWl0IGZjLmFzc2VydChcclxuICAgICAgZmMuYXN5bmNQcm9wZXJ0eShmaWxlTWV0YWRhdGFHZW5lcmF0b3IoKSwgYXN5bmMgKG1ldGFkYXRhOiBGaWxlTWV0YWRhdGEpID0+IHtcclxuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZUZpbGVNZXRhZGF0YShtZXRhZGF0YSlcclxuXHJcbiAgICAgICAgY29uc3QgYmVmb3JlRGVsZXRlID0gYXdhaXQgc2VydmljZS5nZXRGaWxlTWV0YWRhdGEobWV0YWRhdGEuZmlsZV9pZClcclxuICAgICAgICBleHBlY3QoYmVmb3JlRGVsZXRlKS5ub3QudG9CZU51bGwoKVxyXG5cclxuICAgICAgICBhd2FpdCBzZXJ2aWNlLmRlbGV0ZUZpbGVNZXRhZGF0YShtZXRhZGF0YS5maWxlX2lkLCBtZXRhZGF0YS51c2VyX2lkKVxyXG5cclxuICAgICAgICBjb25zdCBhZnRlckRlbGV0ZSA9IGF3YWl0IHNlcnZpY2UuZ2V0RmlsZU1ldGFkYXRhKG1ldGFkYXRhLmZpbGVfaWQpXHJcbiAgICAgICAgZXhwZWN0KGFmdGVyRGVsZXRlKS50b0JlTnVsbCgpXHJcblxyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gY3JlYXRlZEZpbGVJZHMuaW5kZXhPZihtZXRhZGF0YS5maWxlX2lkKVxyXG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XHJcbiAgICAgICAgICBjcmVhdGVkRmlsZUlkcy5zcGxpY2UoaW5kZXgsIDEpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgeyBudW1SdW5zOiAxMDAgfVxyXG4gICAgKVxyXG4gIH0pXHJcblxyXG4gIHRlc3QoJ1Byb3BlcnR5IDEzIChlZGdlIGNhc2UpOiBEZWxldGlvbiBvZiBub24tZXhpc3RlbnQgZmlsZSB0aHJvd3MgZXJyb3InLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBmYy5hc3NlcnQoXHJcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoXHJcbiAgICAgICAgZmMudXVpZCgpLFxyXG4gICAgICAgIGZjLnN0cmluZyh7IG1pbkxlbmd0aDogMSwgbWF4TGVuZ3RoOiA1MCB9KSxcclxuICAgICAgICBhc3luYyAoZmlsZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgICAgIHNlcnZpY2UuZGVsZXRlRmlsZU1ldGFkYXRhKGZpbGVJZCwgdXNlcklkKVxyXG4gICAgICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ZpbGUgbm90IGZvdW5kJylcclxuICAgICAgICB9XHJcbiAgICAgICksXHJcbiAgICAgIHsgbnVtUnVuczogMTAwIH1cclxuICAgIClcclxuICB9KVxyXG5cclxuICB0ZXN0KCdQcm9wZXJ0eSAxMyAoZWRnZSBjYXNlKTogRGVsZXRpb24gZmFpbHMgZm9yIG5vbi1vd25lcicsIGFzeW5jICgpID0+IHtcclxuICAgIGF3YWl0IGZjLmFzc2VydChcclxuICAgICAgZmMuYXN5bmNQcm9wZXJ0eShcclxuICAgICAgICBmaWxlTWV0YWRhdGFHZW5lcmF0b3IoKSxcclxuICAgICAgICBmYy5zdHJpbmcoeyBtaW5MZW5ndGg6IDEsIG1heExlbmd0aDogNTAgfSksXHJcbiAgICAgICAgYXN5bmMgKG1ldGFkYXRhOiBGaWxlTWV0YWRhdGEsIGRpZmZlcmVudFVzZXJJZDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICBmYy5wcmUoZGlmZmVyZW50VXNlcklkICE9PSBtZXRhZGF0YS51c2VyX2lkKVxyXG5cclxuICAgICAgICAgIGNyZWF0ZWRGaWxlSWRzLnB1c2gobWV0YWRhdGEuZmlsZV9pZClcclxuXHJcbiAgICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZUZpbGVNZXRhZGF0YShtZXRhZGF0YSlcclxuXHJcbiAgICAgICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgICAgIHNlcnZpY2UuZGVsZXRlRmlsZU1ldGFkYXRhKG1ldGFkYXRhLmZpbGVfaWQsIGRpZmZlcmVudFVzZXJJZClcclxuICAgICAgICAgICkucmVqZWN0cy50b1Rocm93KCdVbmF1dGhvcml6ZWQnKVxyXG4gICAgICAgIH1cclxuICAgICAgKSxcclxuICAgICAgeyBudW1SdW5zOiAxMDAgfVxyXG4gICAgKVxyXG4gIH0pXHJcblxyXG4gIC8qKlxyXG4gICAqICoqVmFsaWRhdGVzOiBSZXF1aXJlbWVudHMgMS40KipcclxuICAgKi9cclxuICB0ZXN0KCdQcm9wZXJ0eSAyOiBGaWxlIElEIHVuaXF1ZW5lc3MgZW5mb3JjZW1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBmYy5hc3NlcnQoXHJcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoZmlsZU1ldGFkYXRhR2VuZXJhdG9yKCksIGFzeW5jIChtZXRhZGF0YTogRmlsZU1ldGFkYXRhKSA9PiB7XHJcbiAgICAgICAgY3JlYXRlZEZpbGVJZHMucHVzaChtZXRhZGF0YS5maWxlX2lkKVxyXG5cclxuICAgICAgICBhd2FpdCBzZXJ2aWNlLmNyZWF0ZUZpbGVNZXRhZGF0YShtZXRhZGF0YSlcclxuXHJcbiAgICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgICAgc2VydmljZS5jcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGEpXHJcbiAgICAgICAgKS5yZWplY3RzLnRvVGhyb3coKVxyXG4gICAgICB9KSxcclxuICAgICAgeyBudW1SdW5zOiAxMDAgfVxyXG4gICAgKVxyXG4gIH0pXHJcblxyXG4gIC8qKlxyXG4gICAqICoqVmFsaWRhdGVzOiBSZXF1aXJlbWVudHMgMS41KipcclxuICAgKi9cclxuICB0ZXN0KCdQcm9wZXJ0eSAzOiBBdXRvbWF0aWMgdGltZXN0YW1wIGdlbmVyYXRpb24nLCBhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBmYy5hc3NlcnQoXHJcbiAgICAgIGZjLmFzeW5jUHJvcGVydHkoZmlsZU1ldGFkYXRhR2VuZXJhdG9yKCksIGFzeW5jIChtZXRhZGF0YTogRmlsZU1ldGFkYXRhKSA9PiB7XHJcbiAgICAgICAgY3JlYXRlZEZpbGVJZHMucHVzaChtZXRhZGF0YS5maWxlX2lkKVxyXG5cclxuICAgICAgICBjb25zdCBiZWZvcmVUaW1lc3RhbXAgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKVxyXG5cclxuICAgICAgICBjb25zdCBjcmVhdGVkID0gYXdhaXQgc2VydmljZS5jcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGEpXHJcblxyXG4gICAgICAgIGNvbnN0IGFmdGVyVGltZXN0YW1wID0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMClcclxuXHJcbiAgICAgICAgZXhwZWN0KGNyZWF0ZWQudXBsb2FkX3RpbWVzdGFtcCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbChiZWZvcmVUaW1lc3RhbXAgLSAxKVxyXG4gICAgICAgIGV4cGVjdChjcmVhdGVkLnVwbG9hZF90aW1lc3RhbXApLnRvQmVMZXNzVGhhbk9yRXF1YWwoYWZ0ZXJUaW1lc3RhbXAgKyAxKVxyXG5cclxuICAgICAgICBleHBlY3QoY3JlYXRlZC5jcmVhdGVkX2F0KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKGJlZm9yZVRpbWVzdGFtcCAqIDEwMDAgLSAxMDAwKVxyXG4gICAgICAgIGV4cGVjdChjcmVhdGVkLmNyZWF0ZWRfYXQpLnRvQmVMZXNzVGhhbk9yRXF1YWwoYWZ0ZXJUaW1lc3RhbXAgKiAxMDAwICsgMTAwMClcclxuICAgICAgICBleHBlY3QoY3JlYXRlZC51cGRhdGVkX2F0KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKGJlZm9yZVRpbWVzdGFtcCAqIDEwMDAgLSAxMDAwKVxyXG4gICAgICAgIGV4cGVjdChjcmVhdGVkLnVwZGF0ZWRfYXQpLnRvQmVMZXNzVGhhbk9yRXF1YWwoYWZ0ZXJUaW1lc3RhbXAgKiAxMDAwICsgMTAwMClcclxuICAgICAgfSksXHJcbiAgICAgIHsgbnVtUnVuczogMTAwIH1cclxuICAgIClcclxuICB9KVxyXG5cclxuICAvKipcclxuICAgKiAqKlZhbGlkYXRlczogUmVxdWlyZW1lbnRzIDQuMiwgNS4zLCA2LjMqKlxyXG4gICAqL1xyXG4gIHRlc3QoJ1Byb3BlcnR5IDU6IE5vbi1leGlzdGVudCBmaWxlIGVycm9yIGhhbmRsaW5nJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgYXdhaXQgZmMuYXNzZXJ0KFxyXG4gICAgICBmYy5hc3luY1Byb3BlcnR5KFxyXG4gICAgICAgIGZjLnV1aWQoKSxcclxuICAgICAgICBhc3luYyAobm9uRXhpc3RlbnRGaWxlSWQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5nZXRGaWxlTWV0YWRhdGEobm9uRXhpc3RlbnRGaWxlSWQpXHJcbiAgICAgICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpXHJcblxyXG4gICAgICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgICAgICBzZXJ2aWNlLnVwZGF0ZUZpbGVNZXRhZGF0YShub25FeGlzdGVudEZpbGVJZCwgeyBhbmFseXNpc19zdGF0dXM6ICdjb21wbGV0ZWQnIGFzIGFueSB9KVxyXG4gICAgICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ZpbGUgbm90IGZvdW5kJylcclxuXHJcbiAgICAgICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgICAgIHNlcnZpY2UuZGVsZXRlRmlsZU1ldGFkYXRhKG5vbkV4aXN0ZW50RmlsZUlkLCAnc29tZS11c2VyLWlkJylcclxuICAgICAgICAgICkucmVqZWN0cy50b1Rocm93KCdGaWxlIG5vdCBmb3VuZCcpXHJcbiAgICAgICAgfVxyXG4gICAgICApLFxyXG4gICAgICB7IG51bVJ1bnM6IDEwMCB9XHJcbiAgICApXHJcbiAgfSlcclxuXHJcbiAgLyoqXHJcbiAgICogKipWYWxpZGF0ZXM6IFJlcXVpcmVtZW50cyA0LjMsIDYuNCwgNi41KipcclxuICAgKi9cclxuICB0ZXN0KCdQcm9wZXJ0eSAxNTogQmF0Y2ggb3BlcmF0aW9uIGNvbnNpc3RlbmN5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgYXdhaXQgZmMuYXNzZXJ0KFxyXG4gICAgICBmYy5hc3luY1Byb3BlcnR5KFxyXG4gICAgICAgIGZjLmFycmF5KGZpbGVNZXRhZGF0YUdlbmVyYXRvcigpLCB7IG1pbkxlbmd0aDogMiwgbWF4TGVuZ3RoOiAxMCB9KSxcclxuICAgICAgICBhc3luYyAobWV0YWRhdGFBcnJheTogRmlsZU1ldGFkYXRhW10pID0+IHtcclxuICAgICAgICAgIG1ldGFkYXRhQXJyYXkuZm9yRWFjaChtID0+IGNyZWF0ZWRGaWxlSWRzLnB1c2gobS5maWxlX2lkKSlcclxuXHJcbiAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgICAgICAgbWV0YWRhdGFBcnJheS5tYXAobWV0YWRhdGEgPT4gc2VydmljZS5jcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGEpKVxyXG4gICAgICAgICAgKVxyXG5cclxuICAgICAgICAgIGNvbnN0IGZpbGVJZHMgPSBtZXRhZGF0YUFycmF5Lm1hcChtID0+IG0uZmlsZV9pZClcclxuICAgICAgICAgIGNvbnN0IGJhdGNoUmVzdWx0cyA9IGF3YWl0IHNlcnZpY2UuYmF0Y2hHZXRGaWxlcyhmaWxlSWRzKVxyXG5cclxuICAgICAgICAgIGV4cGVjdChiYXRjaFJlc3VsdHMubGVuZ3RoKS50b0JlKG1ldGFkYXRhQXJyYXkubGVuZ3RoKVxyXG5cclxuICAgICAgICAgIGNvbnN0IHJlc3VsdElkcyA9IGJhdGNoUmVzdWx0cy5tYXAociA9PiByLmZpbGVfaWQpXHJcbiAgICAgICAgICBmaWxlSWRzLmZvckVhY2goaWQgPT4ge1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0SWRzKS50b0NvbnRhaW4oaWQpXHJcbiAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgIGJhdGNoUmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsID0gbWV0YWRhdGFBcnJheS5maW5kKG0gPT4gbS5maWxlX2lkID09PSByZXN1bHQuZmlsZV9pZClcclxuICAgICAgICAgICAgZXhwZWN0KG9yaWdpbmFsKS50b0JlRGVmaW5lZCgpXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwob3JpZ2luYWwpXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgICAgKSxcclxuICAgICAgeyBudW1SdW5zOiA1MCB9XHJcbiAgICApXHJcbiAgfSlcclxuXHJcbiAgdGVzdCgnUHJvcGVydHkgMTUgKGVkZ2UgY2FzZSk6IEJhdGNoIGdldCB3aXRoIG5vbi1leGlzdGVudCBmaWxlcycsIGFzeW5jICgpID0+IHtcclxuICAgIGF3YWl0IGZjLmFzc2VydChcclxuICAgICAgZmMuYXN5bmNQcm9wZXJ0eShcclxuICAgICAgICBmYy5hcnJheShmaWxlTWV0YWRhdGFHZW5lcmF0b3IoKSwgeyBtaW5MZW5ndGg6IDIsIG1heExlbmd0aDogNSB9KSxcclxuICAgICAgICBmYy5hcnJheShmYy51dWlkKCksIHsgbWluTGVuZ3RoOiAyLCBtYXhMZW5ndGg6IDUgfSksXHJcbiAgICAgICAgYXN5bmMgKGV4aXN0aW5nTWV0YWRhdGE6IEZpbGVNZXRhZGF0YVtdLCBub25FeGlzdGVudElkczogc3RyaW5nW10pID0+IHtcclxuICAgICAgICAgIGV4aXN0aW5nTWV0YWRhdGEuZm9yRWFjaChtID0+IGNyZWF0ZWRGaWxlSWRzLnB1c2gobS5maWxlX2lkKSlcclxuXHJcbiAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgICAgICAgZXhpc3RpbmdNZXRhZGF0YS5tYXAobWV0YWRhdGEgPT4gc2VydmljZS5jcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGEpKVxyXG4gICAgICAgICAgKVxyXG5cclxuICAgICAgICAgIGNvbnN0IGFsbElkcyA9IFtcclxuICAgICAgICAgICAgLi4uZXhpc3RpbmdNZXRhZGF0YS5tYXAobSA9PiBtLmZpbGVfaWQpLFxyXG4gICAgICAgICAgICAuLi5ub25FeGlzdGVudElkc1xyXG4gICAgICAgICAgXVxyXG5cclxuICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBzZXJ2aWNlLmJhdGNoR2V0RmlsZXMoYWxsSWRzKVxyXG5cclxuICAgICAgICAgIGV4cGVjdChyZXN1bHRzLmxlbmd0aCkudG9CZShleGlzdGluZ01ldGFkYXRhLmxlbmd0aClcclxuXHJcbiAgICAgICAgICBjb25zdCBleGlzdGluZ0lkcyA9IGV4aXN0aW5nTWV0YWRhdGEubWFwKG0gPT4gbS5maWxlX2lkKVxyXG4gICAgICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgIGV4cGVjdChleGlzdGluZ0lkcykudG9Db250YWluKHJlc3VsdC5maWxlX2lkKVxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgICksXHJcbiAgICAgIHsgbnVtUnVuczogNTAgfVxyXG4gICAgKVxyXG4gIH0pXHJcblxyXG4gIHRlc3QoJ1Byb3BlcnR5IDE1IChlZGdlIGNhc2UpOiBCYXRjaCBnZXQgd2l0aCBlbXB0eSBhcnJheScsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBzZXJ2aWNlLmJhdGNoR2V0RmlsZXMoW10pXHJcbiAgICBleHBlY3QocmVzdWx0cykudG9FcXVhbChbXSlcclxuICB9KVxyXG59KVxyXG4iXX0=