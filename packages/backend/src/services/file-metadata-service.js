"use strict";
/**
 * File Metadata Service implementation
 * Provides CRUD operations for file metadata management
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileMetadataService = void 0;
const validation_1 = require("../types/validation");
const file_metadata_validator_1 = require("../validation/file-metadata-validator");
class FileMetadataService {
    dbClient;
    validator;
    constructor(dbClient) {
        this.dbClient = dbClient;
        this.validator = new file_metadata_validator_1.FileMetadataValidator();
    }
    async createFileMetadata(metadata) {
        const validationResult = this.validator.validateCreate(metadata);
        if (!validationResult.isValid) {
            throw new validation_1.MetadataError('Validation failed for file metadata creation', validation_1.ErrorCodes.VALIDATION_ERROR, 400, validationResult.errors);
        }
        try {
            await this.dbClient.putItem(metadata);
            return metadata;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to create file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async getFileMetadata(fileId) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        try {
            const result = await this.dbClient.getItem({ file_id: fileId });
            if (!result) {
                return null;
            }
            return result;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to retrieve file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async updateFileMetadata(fileId, updates) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        const validationResult = this.validator.validateUpdate(updates);
        if (!validationResult.isValid) {
            throw new validation_1.MetadataError('Validation failed for file metadata update', validation_1.ErrorCodes.VALIDATION_ERROR, 400, validationResult.errors);
        }
        try {
            const existing = await this.getFileMetadata(fileId);
            if (!existing) {
                throw new validation_1.MetadataError('File not found', validation_1.ErrorCodes.NOT_FOUND, 404, [{ field: 'file_id', message: `File with ID ${fileId} does not exist`, code: 'NOT_FOUND' }]);
            }
            const updatesWithTimestamp = {
                ...updates,
                updated_at: Math.floor(Date.now() / 1000)
            };
            const updateExpressionParts = [];
            const expressionAttributeNames = {};
            const expressionAttributeValues = {};
            Object.entries(updatesWithTimestamp).forEach(([key, value], index) => {
                const nameKey = `#attr${index}`;
                const valueKey = `:val${index}`;
                updateExpressionParts.push(`${nameKey} = ${valueKey}`);
                expressionAttributeNames[nameKey] = key;
                expressionAttributeValues[valueKey] = value;
            });
            const updateExpression = `SET ${updateExpressionParts.join(', ')}`;
            const result = await this.dbClient.updateItem({ file_id: fileId }, updateExpression, expressionAttributeNames, expressionAttributeValues);
            return result;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to update file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async updateAnalysisStatus(fileId, status) {
        return this.updateFileMetadata(fileId, {
            analysis_status: status,
            updated_at: Math.floor(Date.now() / 1000)
        });
    }
    async deleteFileMetadata(fileId, userId) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        if (!userId || userId.trim().length === 0) {
            throw new validation_1.MetadataError('User ID is required', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'user_id', message: 'User ID cannot be empty', code: 'REQUIRED_FIELD' }]);
        }
        try {
            const existing = await this.getFileMetadata(fileId);
            if (!existing) {
                throw new validation_1.MetadataError('File not found', validation_1.ErrorCodes.NOT_FOUND, 404, [{ field: 'file_id', message: `File with ID ${fileId} does not exist`, code: 'NOT_FOUND' }]);
            }
            if (existing.user_id !== userId) {
                throw new validation_1.MetadataError('Unauthorized: User does not own this file', validation_1.ErrorCodes.UNAUTHORIZED, 403, [{ field: 'user_id', message: 'Cannot delete files owned by other users', code: 'UNAUTHORIZED' }]);
            }
            await this.dbClient.deleteItem({ file_id: fileId });
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to delete file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async getUserFiles(userId, pagination) {
        if (!userId || userId.trim().length === 0) {
            throw new validation_1.MetadataError('User ID is required', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'user_id', message: 'User ID cannot be empty', code: 'REQUIRED_FIELD' }]);
        }
        try {
            const result = await this.dbClient.queryByIndex('UserIndex', 'user_id', userId, {
                limit: pagination?.limit || 50,
                exclusiveStartKey: pagination?.exclusiveStartKey
            });
            return {
                items: result.items,
                lastEvaluatedKey: result.lastEvaluatedKey,
                count: result.count,
                scannedCount: result.scannedCount
            };
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to retrieve user files', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async getFilesByUserId(userId) {
        const result = await this.getUserFiles(userId, { limit: 100 });
        return result.items;
    }
    async getFilesByStatus(_status, _pagination) {
        throw new Error('Not implemented yet - will be implemented in Task 7.3');
    }
    async getUserFilesByStatus(_userId, _status) {
        throw new Error('Not implemented yet - will be implemented in Task 7.4');
    }
    async batchGetFiles(fileIds) {
        if (!fileIds || fileIds.length === 0) {
            return [];
        }
        const invalidIds = fileIds.filter(id => !this.validator.validateFileId(id));
        if (invalidIds.length > 0) {
            throw new validation_1.MetadataError('Invalid file ID format in batch request', validation_1.ErrorCodes.VALIDATION_ERROR, 400, invalidIds.map(id => ({
                field: 'file_id',
                message: `Invalid UUID: ${id}`,
                code: 'INVALID_UUID'
            })));
        }
        try {
            const keys = fileIds.map(fileId => ({ file_id: fileId }));
            const results = await this.dbClient.batchGetItems(keys);
            return results;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to batch retrieve file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async batchDeleteFiles(_fileIds, _userId) {
        throw new Error('Not implemented yet - will be implemented in Task 6.3');
    }
}
exports.FileMetadataService = FileMetadataService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1tZXRhZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZS1tZXRhZGF0YS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQVFILG9EQUErRDtBQUUvRCxtRkFBNkU7QUFlN0UsTUFBYSxtQkFBbUI7SUFJWDtJQUhGLFNBQVMsQ0FBdUI7SUFFakQsWUFDbUIsUUFBK0I7UUFBL0IsYUFBUSxHQUFSLFFBQVEsQ0FBdUI7UUFFaEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLCtDQUFxQixFQUFFLENBQUE7SUFDOUMsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxRQUFzQjtRQUM3QyxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2hFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM5QixNQUFNLElBQUksMEJBQWEsQ0FDckIsOENBQThDLEVBQzlDLHVCQUFVLENBQUMsZ0JBQWdCLEVBQzNCLEdBQUcsRUFDSCxnQkFBZ0IsQ0FBQyxNQUFNLENBQ3hCLENBQUE7UUFDSCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUErQixDQUFDLENBQUE7WUFDNUQsT0FBTyxRQUFRLENBQUE7UUFDakIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLEtBQUssWUFBWSwwQkFBYSxFQUFFLENBQUM7Z0JBQ25DLE1BQU0sS0FBSyxDQUFBO1lBQ2IsQ0FBQztZQUNELE1BQU0sSUFBSSwwQkFBYSxDQUNyQixnQ0FBZ0MsRUFDaEMsdUJBQVUsQ0FBQyxjQUFjLEVBQ3pCLEdBQUcsRUFDSCxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FDM0MsQ0FBQTtR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Qix3Q0FBd0MsRUFDeEMsdUJBQVUsQ0FBQyxjQUFjLEVBQ3pCLEdBQUcsRUFDSCxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FDM0MsQ0FBQTtRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFFBQWtCLEVBQUUsT0FBZTtRQUN4RCxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUE7SUFDMUUsQ0FBQztDQUNGO0FBOVNELGtEQThTQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBGaWxlIE1ldGFkYXRhIFNlcnZpY2UgaW1wbGVtZW50YXRpb25cclxuICogUHJvdmlkZXMgQ1JVRCBvcGVyYXRpb25zIGZvciBmaWxlIG1ldGFkYXRhIG1hbmFnZW1lbnRcclxuICovXHJcblxyXG5pbXBvcnQgeyBcclxuICBGaWxlTWV0YWRhdGEsIFxyXG4gIFBhZ2luYXRpb25PcHRpb25zLCBcclxuICBQYWdpbmF0ZWRSZXN1bHQsIFxyXG4gIEFuYWx5c2lzU3RhdHVzIFxyXG59IGZyb20gJy4uL3R5cGVzL2ZpbGUtbWV0YWRhdGEnXHJcbmltcG9ydCB7IE1ldGFkYXRhRXJyb3IsIEVycm9yQ29kZXMgfSBmcm9tICcuLi90eXBlcy92YWxpZGF0aW9uJ1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudFdyYXBwZXIgfSBmcm9tICcuLi9kYXRhYmFzZS9keW5hbW9kYi1jbGllbnQnXHJcbmltcG9ydCB7IEZpbGVNZXRhZGF0YVZhbGlkYXRvciB9IGZyb20gJy4uL3ZhbGlkYXRpb24vZmlsZS1tZXRhZGF0YS12YWxpZGF0b3InXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElGaWxlTWV0YWRhdGFTZXJ2aWNlIHtcclxuICBjcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGE6IEZpbGVNZXRhZGF0YSk6IFByb21pc2U8RmlsZU1ldGFkYXRhPlxyXG4gIGdldEZpbGVNZXRhZGF0YShmaWxlSWQ6IHN0cmluZyk6IFByb21pc2U8RmlsZU1ldGFkYXRhIHwgbnVsbD5cclxuICB1cGRhdGVGaWxlTWV0YWRhdGEoZmlsZUlkOiBzdHJpbmcsIHVwZGF0ZXM6IFBhcnRpYWw8RmlsZU1ldGFkYXRhPik6IFByb21pc2U8RmlsZU1ldGFkYXRhPlxyXG4gIHVwZGF0ZUFuYWx5c2lzU3RhdHVzKGZpbGVJZDogc3RyaW5nLCBzdGF0dXM6IEFuYWx5c2lzU3RhdHVzKTogUHJvbWlzZTxGaWxlTWV0YWRhdGE+XHJcbiAgZGVsZXRlRmlsZU1ldGFkYXRhKGZpbGVJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD5cclxuICBnZXRVc2VyRmlsZXModXNlcklkOiBzdHJpbmcsIHBhZ2luYXRpb24/OiBQYWdpbmF0aW9uT3B0aW9ucyk6IFByb21pc2U8UGFnaW5hdGVkUmVzdWx0PEZpbGVNZXRhZGF0YT4+XHJcbiAgZ2V0RmlsZXNCeVN0YXR1cyhzdGF0dXM6IEFuYWx5c2lzU3RhdHVzLCBwYWdpbmF0aW9uPzogUGFnaW5hdGlvbk9wdGlvbnMpOiBQcm9taXNlPFBhZ2luYXRlZFJlc3VsdDxGaWxlTWV0YWRhdGE+PlxyXG4gIGdldFVzZXJGaWxlc0J5U3RhdHVzKHVzZXJJZDogc3RyaW5nLCBzdGF0dXM6IEFuYWx5c2lzU3RhdHVzKTogUHJvbWlzZTxGaWxlTWV0YWRhdGFbXT5cclxuICBiYXRjaEdldEZpbGVzKGZpbGVJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxGaWxlTWV0YWRhdGFbXT5cclxuICBiYXRjaERlbGV0ZUZpbGVzKGZpbGVJZHM6IHN0cmluZ1tdLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBGaWxlTWV0YWRhdGFTZXJ2aWNlIGltcGxlbWVudHMgSUZpbGVNZXRhZGF0YVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdmFsaWRhdG9yOiBGaWxlTWV0YWRhdGFWYWxpZGF0b3JcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRiQ2xpZW50OiBEeW5hbW9EQkNsaWVudFdyYXBwZXJcclxuICApIHtcclxuICAgIHRoaXMudmFsaWRhdG9yID0gbmV3IEZpbGVNZXRhZGF0YVZhbGlkYXRvcigpXHJcbiAgfVxyXG5cclxuICBhc3luYyBjcmVhdGVGaWxlTWV0YWRhdGEobWV0YWRhdGE6IEZpbGVNZXRhZGF0YSk6IFByb21pc2U8RmlsZU1ldGFkYXRhPiB7XHJcbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gdGhpcy52YWxpZGF0b3IudmFsaWRhdGVDcmVhdGUobWV0YWRhdGEpXHJcbiAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuaXNWYWxpZCkge1xyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnVmFsaWRhdGlvbiBmYWlsZWQgZm9yIGZpbGUgbWV0YWRhdGEgY3JlYXRpb24nLFxyXG4gICAgICAgIEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgdmFsaWRhdGlvblJlc3VsdC5lcnJvcnNcclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuZGJDbGllbnQucHV0SXRlbShtZXRhZGF0YSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KVxyXG4gICAgICByZXR1cm4gbWV0YWRhdGFcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE1ldGFkYXRhRXJyb3IpIHtcclxuICAgICAgICB0aHJvdyBlcnJvclxyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdGYWlsZWQgdG8gY3JlYXRlIGZpbGUgbWV0YWRhdGEnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuREFUQUJBU0VfRVJST1IsXHJcbiAgICAgICAgNTAwLFxyXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IHVuZGVmaW5lZFxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRGaWxlTWV0YWRhdGEoZmlsZUlkOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVNZXRhZGF0YSB8IG51bGw+IHtcclxuICAgIGlmICghdGhpcy52YWxpZGF0b3IudmFsaWRhdGVGaWxlSWQoZmlsZUlkKSkge1xyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnSW52YWxpZCBmaWxlIElEIGZvcm1hdCcsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5WQUxJREFUSU9OX0VSUk9SLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBbeyBmaWVsZDogJ2ZpbGVfaWQnLCBtZXNzYWdlOiAnTXVzdCBiZSBhIHZhbGlkIFVVSUQgdjQnLCBjb2RlOiAnSU5WQUxJRF9VVUlEJyB9XVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYkNsaWVudC5nZXRJdGVtKHsgZmlsZV9pZDogZmlsZUlkIH0pXHJcblxyXG4gICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiByZXN1bHQgYXMgRmlsZU1ldGFkYXRhXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBNZXRhZGF0YUVycm9yKSB7XHJcbiAgICAgICAgdGhyb3cgZXJyb3JcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnRmFpbGVkIHRvIHJldHJpZXZlIGZpbGUgbWV0YWRhdGEnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuREFUQUJBU0VfRVJST1IsXHJcbiAgICAgICAgNTAwLFxyXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IHVuZGVmaW5lZFxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVGaWxlTWV0YWRhdGEoXHJcbiAgICBmaWxlSWQ6IHN0cmluZyxcclxuICAgIHVwZGF0ZXM6IFBhcnRpYWw8RmlsZU1ldGFkYXRhPlxyXG4gICk6IFByb21pc2U8RmlsZU1ldGFkYXRhPiB7XHJcbiAgICBpZiAoIXRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRmlsZUlkKGZpbGVJZCkpIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ludmFsaWQgZmlsZSBJRCBmb3JtYXQnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgW3sgZmllbGQ6ICdmaWxlX2lkJywgbWVzc2FnZTogJ011c3QgYmUgYSB2YWxpZCBVVUlEIHY0JywgY29kZTogJ0lOVkFMSURfVVVJRCcgfV1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB0aGlzLnZhbGlkYXRvci52YWxpZGF0ZVVwZGF0ZSh1cGRhdGVzKVxyXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ1ZhbGlkYXRpb24gZmFpbGVkIGZvciBmaWxlIG1ldGFkYXRhIHVwZGF0ZScsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5WQUxJREFUSU9OX0VSUk9SLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICB2YWxpZGF0aW9uUmVzdWx0LmVycm9yc1xyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmdldEZpbGVNZXRhZGF0YShmaWxlSWQpXHJcbiAgICAgIGlmICghZXhpc3RpbmcpIHtcclxuICAgICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAgICdGaWxlIG5vdCBmb3VuZCcsXHJcbiAgICAgICAgICBFcnJvckNvZGVzLk5PVF9GT1VORCxcclxuICAgICAgICAgIDQwNCxcclxuICAgICAgICAgIFt7IGZpZWxkOiAnZmlsZV9pZCcsIG1lc3NhZ2U6IGBGaWxlIHdpdGggSUQgJHtmaWxlSWR9IGRvZXMgbm90IGV4aXN0YCwgY29kZTogJ05PVF9GT1VORCcgfV1cclxuICAgICAgICApXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHVwZGF0ZXNXaXRoVGltZXN0YW1wID0ge1xyXG4gICAgICAgIC4uLnVwZGF0ZXMsXHJcbiAgICAgICAgdXBkYXRlZF9hdDogTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMClcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgdXBkYXRlRXhwcmVzc2lvblBhcnRzOiBzdHJpbmdbXSA9IFtdXHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fVxyXG5cclxuICAgICAgT2JqZWN0LmVudHJpZXModXBkYXRlc1dpdGhUaW1lc3RhbXApLmZvckVhY2goKFtrZXksIHZhbHVlXSwgaW5kZXgpID0+IHtcclxuICAgICAgICBjb25zdCBuYW1lS2V5ID0gYCNhdHRyJHtpbmRleH1gXHJcbiAgICAgICAgY29uc3QgdmFsdWVLZXkgPSBgOnZhbCR7aW5kZXh9YFxyXG4gICAgICAgIHVwZGF0ZUV4cHJlc3Npb25QYXJ0cy5wdXNoKGAke25hbWVLZXl9ID0gJHt2YWx1ZUtleX1gKVxyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1tuYW1lS2V5XSA9IGtleVxyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbdmFsdWVLZXldID0gdmFsdWVcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb24gPSBgU0VUICR7dXBkYXRlRXhwcmVzc2lvblBhcnRzLmpvaW4oJywgJyl9YFxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYkNsaWVudC51cGRhdGVJdGVtKFxyXG4gICAgICAgIHsgZmlsZV9pZDogZmlsZUlkIH0sXHJcbiAgICAgICAgdXBkYXRlRXhwcmVzc2lvbixcclxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1xyXG4gICAgICApXHJcblxyXG4gICAgICByZXR1cm4gcmVzdWx0IGFzIEZpbGVNZXRhZGF0YVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTWV0YWRhdGFFcnJvcikge1xyXG4gICAgICAgIHRocm93IGVycm9yXHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ZhaWxlZCB0byB1cGRhdGUgZmlsZSBtZXRhZGF0YScsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5EQVRBQkFTRV9FUlJPUixcclxuICAgICAgICA1MDAsXHJcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXHJcbiAgICAgIClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZUFuYWx5c2lzU3RhdHVzKGZpbGVJZDogc3RyaW5nLCBzdGF0dXM6IEFuYWx5c2lzU3RhdHVzKTogUHJvbWlzZTxGaWxlTWV0YWRhdGE+IHtcclxuICAgIHJldHVybiB0aGlzLnVwZGF0ZUZpbGVNZXRhZGF0YShmaWxlSWQsIHtcclxuICAgICAgYW5hbHlzaXNfc3RhdHVzOiBzdGF0dXMsXHJcbiAgICAgIHVwZGF0ZWRfYXQ6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsZXRlRmlsZU1ldGFkYXRhKGZpbGVJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgaWYgKCF0aGlzLnZhbGlkYXRvci52YWxpZGF0ZUZpbGVJZChmaWxlSWQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdJbnZhbGlkIGZpbGUgSUQgZm9ybWF0JyxcclxuICAgICAgICBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIFt7IGZpZWxkOiAnZmlsZV9pZCcsIG1lc3NhZ2U6ICdNdXN0IGJlIGEgdmFsaWQgVVVJRCB2NCcsIGNvZGU6ICdJTlZBTElEX1VVSUQnIH1dXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXVzZXJJZCB8fCB1c2VySWQudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnVXNlciBJRCBpcyByZXF1aXJlZCcsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5WQUxJREFUSU9OX0VSUk9SLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBbeyBmaWVsZDogJ3VzZXJfaWQnLCBtZXNzYWdlOiAnVXNlciBJRCBjYW5ub3QgYmUgZW1wdHknLCBjb2RlOiAnUkVRVUlSRURfRklFTEQnIH1dXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMuZ2V0RmlsZU1ldGFkYXRhKGZpbGVJZClcclxuICAgICAgaWYgKCFleGlzdGluZykge1xyXG4gICAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICAgJ0ZpbGUgbm90IGZvdW5kJyxcclxuICAgICAgICAgIEVycm9yQ29kZXMuTk9UX0ZPVU5ELFxyXG4gICAgICAgICAgNDA0LFxyXG4gICAgICAgICAgW3sgZmllbGQ6ICdmaWxlX2lkJywgbWVzc2FnZTogYEZpbGUgd2l0aCBJRCAke2ZpbGVJZH0gZG9lcyBub3QgZXhpc3RgLCBjb2RlOiAnTk9UX0ZPVU5EJyB9XVxyXG4gICAgICAgIClcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGV4aXN0aW5nLnVzZXJfaWQgIT09IHVzZXJJZCkge1xyXG4gICAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICAgJ1VuYXV0aG9yaXplZDogVXNlciBkb2VzIG5vdCBvd24gdGhpcyBmaWxlJyxcclxuICAgICAgICAgIEVycm9yQ29kZXMuVU5BVVRIT1JJWkVELFxyXG4gICAgICAgICAgNDAzLFxyXG4gICAgICAgICAgW3sgZmllbGQ6ICd1c2VyX2lkJywgbWVzc2FnZTogJ0Nhbm5vdCBkZWxldGUgZmlsZXMgb3duZWQgYnkgb3RoZXIgdXNlcnMnLCBjb2RlOiAnVU5BVVRIT1JJWkVEJyB9XVxyXG4gICAgICAgIClcclxuICAgICAgfVxyXG5cclxuICAgICAgYXdhaXQgdGhpcy5kYkNsaWVudC5kZWxldGVJdGVtKHsgZmlsZV9pZDogZmlsZUlkIH0pXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBNZXRhZGF0YUVycm9yKSB7XHJcbiAgICAgICAgdGhyb3cgZXJyb3JcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnRmFpbGVkIHRvIGRlbGV0ZSBmaWxlIG1ldGFkYXRhJyxcclxuICAgICAgICBFcnJvckNvZGVzLkRBVEFCQVNFX0VSUk9SLFxyXG4gICAgICAgIDUwMCxcclxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcclxuICAgICAgKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VXNlckZpbGVzKFxyXG4gICAgdXNlcklkOiBzdHJpbmcsXHJcbiAgICBwYWdpbmF0aW9uPzogUGFnaW5hdGlvbk9wdGlvbnNcclxuICApOiBQcm9taXNlPFBhZ2luYXRlZFJlc3VsdDxGaWxlTWV0YWRhdGE+PiB7XHJcbiAgICBpZiAoIXVzZXJJZCB8fCB1c2VySWQudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnVXNlciBJRCBpcyByZXF1aXJlZCcsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5WQUxJREFUSU9OX0VSUk9SLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBbeyBmaWVsZDogJ3VzZXJfaWQnLCBtZXNzYWdlOiAnVXNlciBJRCBjYW5ub3QgYmUgZW1wdHknLCBjb2RlOiAnUkVRVUlSRURfRklFTEQnIH1dXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiQ2xpZW50LnF1ZXJ5QnlJbmRleChcclxuICAgICAgICAnVXNlckluZGV4JyxcclxuICAgICAgICAndXNlcl9pZCcsXHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIGxpbWl0OiBwYWdpbmF0aW9uPy5saW1pdCB8fCA1MCxcclxuICAgICAgICAgIGV4Y2x1c2l2ZVN0YXJ0S2V5OiBwYWdpbmF0aW9uPy5leGNsdXNpdmVTdGFydEtleVxyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBpdGVtczogcmVzdWx0Lml0ZW1zIGFzIEZpbGVNZXRhZGF0YVtdLFxyXG4gICAgICAgIGxhc3RFdmFsdWF0ZWRLZXk6IHJlc3VsdC5sYXN0RXZhbHVhdGVkS2V5LFxyXG4gICAgICAgIGNvdW50OiByZXN1bHQuY291bnQsXHJcbiAgICAgICAgc2Nhbm5lZENvdW50OiByZXN1bHQuc2Nhbm5lZENvdW50XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE1ldGFkYXRhRXJyb3IpIHtcclxuICAgICAgICB0aHJvdyBlcnJvclxyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdGYWlsZWQgdG8gcmV0cmlldmUgdXNlciBmaWxlcycsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5EQVRBQkFTRV9FUlJPUixcclxuICAgICAgICA1MDAsXHJcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXHJcbiAgICAgIClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldEZpbGVzQnlVc2VySWQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVNZXRhZGF0YVtdPiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmdldFVzZXJGaWxlcyh1c2VySWQsIHsgbGltaXQ6IDEwMCB9KVxyXG4gICAgcmV0dXJuIHJlc3VsdC5pdGVtc1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RmlsZXNCeVN0YXR1cyhcclxuICAgIF9zdGF0dXM6IEFuYWx5c2lzU3RhdHVzLFxyXG4gICAgX3BhZ2luYXRpb24/OiBQYWdpbmF0aW9uT3B0aW9uc1xyXG4gICk6IFByb21pc2U8UGFnaW5hdGVkUmVzdWx0PEZpbGVNZXRhZGF0YT4+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkIHlldCAtIHdpbGwgYmUgaW1wbGVtZW50ZWQgaW4gVGFzayA3LjMnKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VXNlckZpbGVzQnlTdGF0dXMoXHJcbiAgICBfdXNlcklkOiBzdHJpbmcsXHJcbiAgICBfc3RhdHVzOiBBbmFseXNpc1N0YXR1c1xyXG4gICk6IFByb21pc2U8RmlsZU1ldGFkYXRhW10+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkIHlldCAtIHdpbGwgYmUgaW1wbGVtZW50ZWQgaW4gVGFzayA3LjQnKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgYmF0Y2hHZXRGaWxlcyhmaWxlSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8RmlsZU1ldGFkYXRhW10+IHtcclxuICAgIGlmICghZmlsZUlkcyB8fCBmaWxlSWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gW11cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpbnZhbGlkSWRzID0gZmlsZUlkcy5maWx0ZXIoaWQgPT4gIXRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRmlsZUlkKGlkKSlcclxuICAgIGlmIChpbnZhbGlkSWRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ludmFsaWQgZmlsZSBJRCBmb3JtYXQgaW4gYmF0Y2ggcmVxdWVzdCcsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5WQUxJREFUSU9OX0VSUk9SLFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBpbnZhbGlkSWRzLm1hcChpZCA9PiAoeyBcclxuICAgICAgICAgIGZpZWxkOiAnZmlsZV9pZCcsIFxyXG4gICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgVVVJRDogJHtpZH1gLCBcclxuICAgICAgICAgIGNvZGU6ICdJTlZBTElEX1VVSUQnIFxyXG4gICAgICAgIH0pKVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qga2V5cyA9IGZpbGVJZHMubWFwKGZpbGVJZCA9PiAoeyBmaWxlX2lkOiBmaWxlSWQgfSkpXHJcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLmRiQ2xpZW50LmJhdGNoR2V0SXRlbXMoa2V5cylcclxuICAgICAgcmV0dXJuIHJlc3VsdHMgYXMgRmlsZU1ldGFkYXRhW11cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE1ldGFkYXRhRXJyb3IpIHtcclxuICAgICAgICB0aHJvdyBlcnJvclxyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdGYWlsZWQgdG8gYmF0Y2ggcmV0cmlldmUgZmlsZSBtZXRhZGF0YScsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5EQVRBQkFTRV9FUlJPUixcclxuICAgICAgICA1MDAsXHJcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXHJcbiAgICAgIClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGJhdGNoRGVsZXRlRmlsZXMoX2ZpbGVJZHM6IHN0cmluZ1tdLCBfdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCB5ZXQgLSB3aWxsIGJlIGltcGxlbWVudGVkIGluIFRhc2sgNi4zJylcclxuICB9XHJcbn1cclxuIl19