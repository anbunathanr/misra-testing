"use strict";
/**
 * File Metadata Service implementation
 * Provides CRUD operations for file metadata management
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileMetadataService = void 0;
const validation_1 = require("../types/validation");
const file_metadata_validator_1 = require("../validation/file-metadata-validator");
class FileMetadataService {
    dbClient;
    validator;
    constructor(dbClient) {
        this.dbClient = dbClient;
        this.validator = new file_metadata_validator_1.FileMetadataValidator();
    }
    async createFileMetadata(metadata) {
        const validationResult = this.validator.validateCreate(metadata);
        if (!validationResult.isValid) {
            throw new validation_1.MetadataError('Validation failed for file metadata creation', validation_1.ErrorCodes.VALIDATION_ERROR, 400, validationResult.errors);
        }
        try {
            await this.dbClient.putItem(metadata);
            return metadata;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to create file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async getFileMetadata(fileId) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        try {
            const result = await this.dbClient.getItem({ file_id: fileId });
            if (!result) {
                return null;
            }
            return result;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to retrieve file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async updateFileMetadata(fileId, updates) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        const validationResult = this.validator.validateUpdate(updates);
        if (!validationResult.isValid) {
            throw new validation_1.MetadataError('Validation failed for file metadata update', validation_1.ErrorCodes.VALIDATION_ERROR, 400, validationResult.errors);
        }
        try {
            const existing = await this.getFileMetadata(fileId);
            if (!existing) {
                throw new validation_1.MetadataError('File not found', validation_1.ErrorCodes.NOT_FOUND, 404, [{ field: 'file_id', message: `File with ID ${fileId} does not exist`, code: 'NOT_FOUND' }]);
            }
            const updatesWithTimestamp = {
                ...updates,
                updated_at: Date.now()
            };
            const updateExpressionParts = [];
            const expressionAttributeNames = {};
            const expressionAttributeValues = {};
            Object.entries(updatesWithTimestamp).forEach(([key, value], index) => {
                const nameKey = `#attr${index}`;
                const valueKey = `:val${index}`;
                updateExpressionParts.push(`${nameKey} = ${valueKey}`);
                expressionAttributeNames[nameKey] = key;
                expressionAttributeValues[valueKey] = value;
            });
            const updateExpression = `SET ${updateExpressionParts.join(', ')}`;
            const result = await this.dbClient.updateItem({ file_id: fileId }, updateExpression, expressionAttributeNames, expressionAttributeValues);
            return result;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to update file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async updateAnalysisStatus(fileId, status) {
        return this.updateFileMetadata(fileId, {
            analysis_status: status,
            updated_at: Date.now()
        });
    }
    async deleteFileMetadata(fileId, userId) {
        if (!this.validator.validateFileId(fileId)) {
            throw new validation_1.MetadataError('Invalid file ID format', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'file_id', message: 'Must be a valid UUID v4', code: 'INVALID_UUID' }]);
        }
        if (!userId || userId.trim().length === 0) {
            throw new validation_1.MetadataError('User ID is required', validation_1.ErrorCodes.VALIDATION_ERROR, 400, [{ field: 'user_id', message: 'User ID cannot be empty', code: 'REQUIRED_FIELD' }]);
        }
        try {
            const existing = await this.getFileMetadata(fileId);
            if (!existing) {
                throw new validation_1.MetadataError('File not found', validation_1.ErrorCodes.NOT_FOUND, 404, [{ field: 'file_id', message: `File with ID ${fileId} does not exist`, code: 'NOT_FOUND' }]);
            }
            if (existing.user_id !== userId) {
                throw new validation_1.MetadataError('Unauthorized: User does not own this file', validation_1.ErrorCodes.UNAUTHORIZED, 403, [{ field: 'user_id', message: 'Cannot delete files owned by other users', code: 'UNAUTHORIZED' }]);
            }
            await this.dbClient.deleteItem({ file_id: fileId });
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to delete file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async getUserFiles(_userId, _pagination) {
        throw new Error('Not implemented yet - will be implemented in Task 7.1');
    }
    async getFilesByStatus(_status, _pagination) {
        throw new Error('Not implemented yet - will be implemented in Task 7.3');
    }
    async getUserFilesByStatus(_userId, _status) {
        throw new Error('Not implemented yet - will be implemented in Task 7.4');
    }
    async batchGetFiles(fileIds) {
        if (!fileIds || fileIds.length === 0) {
            return [];
        }
        const invalidIds = fileIds.filter(id => !this.validator.validateFileId(id));
        if (invalidIds.length > 0) {
            throw new validation_1.MetadataError('Invalid file ID format in batch request', validation_1.ErrorCodes.VALIDATION_ERROR, 400, invalidIds.map(id => ({
                field: 'file_id',
                message: `Invalid UUID: ${id}`,
                code: 'INVALID_UUID'
            })));
        }
        try {
            const keys = fileIds.map(fileId => ({ file_id: fileId }));
            const results = await this.dbClient.batchGetItems(keys);
            return results;
        }
        catch (error) {
            if (error instanceof validation_1.MetadataError) {
                throw error;
            }
            throw new validation_1.MetadataError('Failed to batch retrieve file metadata', validation_1.ErrorCodes.DATABASE_ERROR, 500, error instanceof Error ? error : undefined);
        }
    }
    async batchDeleteFiles(_fileIds, _userId) {
        throw new Error('Not implemented yet - will be implemented in Task 6.3');
    }
}
exports.FileMetadataService = FileMetadataService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1tZXRhZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmlsZS1tZXRhZGF0YS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQVFILG9EQUErRDtBQUUvRCxtRkFBNkU7QUFlN0UsTUFBYSxtQkFBbUI7SUFJWDtJQUhGLFNBQVMsQ0FBdUI7SUFFakQsWUFDbUIsUUFBK0I7UUFBL0IsYUFBUSxHQUFSLFFBQVEsQ0FBdUI7UUFFaEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLCtDQUFxQixFQUFFLENBQUE7SUFDOUMsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxRQUFzQjtRQUM3QyxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2hFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM5QixNQUFNLElBQUksMEJBQWEsQ0FDckIsOENBQThDLEVBQzlDLHVCQUFVLENBQUMsZ0JBQWdCLEVBQzNCLEdBQUcsRUFDSCxnQkFBZ0IsQ0FBQyxNQUFNLENBQ3hCLENBQUE7UUFDSCxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUErQixDQUFDLENBQUE7WUFDNUQsT0FBTyxRQUFRLENBQUE7UUFDakIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixJQUFJLEtBQUssWUFBWSwwQkFBYSxFQUFFLENBQUM7Z0JBQ25DLE1BQU0sS0FBSyxDQUFBO1lBQ2IsQ0FBQztZQUNELE1BQU0sSUFBSSwwQkFBYSxDQUNyQixnQ0FBZ0MsRUFDaEMsdUJBQVUsQ0FBQyxjQUFjLEVBQ3pCLEdBQUcsRUFDSCxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FDM0MsQ0FBQTtR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QUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFrQixFQUFFLE9BQWU7UUFDeEQsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFBO0lBQzFFLENBQUM7Q0FDRjtBQXJRRCxrREFxUUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogRmlsZSBNZXRhZGF0YSBTZXJ2aWNlIGltcGxlbWVudGF0aW9uXHJcbiAqIFByb3ZpZGVzIENSVUQgb3BlcmF0aW9ucyBmb3IgZmlsZSBtZXRhZGF0YSBtYW5hZ2VtZW50XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgXHJcbiAgRmlsZU1ldGFkYXRhLCBcclxuICBQYWdpbmF0aW9uT3B0aW9ucywgXHJcbiAgUGFnaW5hdGVkUmVzdWx0LCBcclxuICBBbmFseXNpc1N0YXR1cyBcclxufSBmcm9tICcuLi90eXBlcy9maWxlLW1ldGFkYXRhJ1xyXG5pbXBvcnQgeyBNZXRhZGF0YUVycm9yLCBFcnJvckNvZGVzIH0gZnJvbSAnLi4vdHlwZXMvdmFsaWRhdGlvbidcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnRXcmFwcGVyIH0gZnJvbSAnLi4vZGF0YWJhc2UvZHluYW1vZGItY2xpZW50J1xyXG5pbXBvcnQgeyBGaWxlTWV0YWRhdGFWYWxpZGF0b3IgfSBmcm9tICcuLi92YWxpZGF0aW9uL2ZpbGUtbWV0YWRhdGEtdmFsaWRhdG9yJ1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJRmlsZU1ldGFkYXRhU2VydmljZSB7XHJcbiAgY3JlYXRlRmlsZU1ldGFkYXRhKG1ldGFkYXRhOiBGaWxlTWV0YWRhdGEpOiBQcm9taXNlPEZpbGVNZXRhZGF0YT5cclxuICBnZXRGaWxlTWV0YWRhdGEoZmlsZUlkOiBzdHJpbmcpOiBQcm9taXNlPEZpbGVNZXRhZGF0YSB8IG51bGw+XHJcbiAgdXBkYXRlRmlsZU1ldGFkYXRhKGZpbGVJZDogc3RyaW5nLCB1cGRhdGVzOiBQYXJ0aWFsPEZpbGVNZXRhZGF0YT4pOiBQcm9taXNlPEZpbGVNZXRhZGF0YT5cclxuICB1cGRhdGVBbmFseXNpc1N0YXR1cyhmaWxlSWQ6IHN0cmluZywgc3RhdHVzOiBBbmFseXNpc1N0YXR1cyk6IFByb21pc2U8RmlsZU1ldGFkYXRhPlxyXG4gIGRlbGV0ZUZpbGVNZXRhZGF0YShmaWxlSWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+XHJcbiAgZ2V0VXNlckZpbGVzKHVzZXJJZDogc3RyaW5nLCBwYWdpbmF0aW9uPzogUGFnaW5hdGlvbk9wdGlvbnMpOiBQcm9taXNlPFBhZ2luYXRlZFJlc3VsdDxGaWxlTWV0YWRhdGE+PlxyXG4gIGdldEZpbGVzQnlTdGF0dXMoc3RhdHVzOiBBbmFseXNpc1N0YXR1cywgcGFnaW5hdGlvbj86IFBhZ2luYXRpb25PcHRpb25zKTogUHJvbWlzZTxQYWdpbmF0ZWRSZXN1bHQ8RmlsZU1ldGFkYXRhPj5cclxuICBnZXRVc2VyRmlsZXNCeVN0YXR1cyh1c2VySWQ6IHN0cmluZywgc3RhdHVzOiBBbmFseXNpc1N0YXR1cyk6IFByb21pc2U8RmlsZU1ldGFkYXRhW10+XHJcbiAgYmF0Y2hHZXRGaWxlcyhmaWxlSWRzOiBzdHJpbmdbXSk6IFByb21pc2U8RmlsZU1ldGFkYXRhW10+XHJcbiAgYmF0Y2hEZWxldGVGaWxlcyhmaWxlSWRzOiBzdHJpbmdbXSwgdXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPlxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRmlsZU1ldGFkYXRhU2VydmljZSBpbXBsZW1lbnRzIElGaWxlTWV0YWRhdGFTZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IHZhbGlkYXRvcjogRmlsZU1ldGFkYXRhVmFsaWRhdG9yXHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBkYkNsaWVudDogRHluYW1vREJDbGllbnRXcmFwcGVyXHJcbiAgKSB7XHJcbiAgICB0aGlzLnZhbGlkYXRvciA9IG5ldyBGaWxlTWV0YWRhdGFWYWxpZGF0b3IoKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgY3JlYXRlRmlsZU1ldGFkYXRhKG1ldGFkYXRhOiBGaWxlTWV0YWRhdGEpOiBQcm9taXNlPEZpbGVNZXRhZGF0YT4ge1xyXG4gICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlQ3JlYXRlKG1ldGFkYXRhKVxyXG4gICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LmlzVmFsaWQpIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ1ZhbGlkYXRpb24gZmFpbGVkIGZvciBmaWxlIG1ldGFkYXRhIGNyZWF0aW9uJyxcclxuICAgICAgICBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIHZhbGlkYXRpb25SZXN1bHQuZXJyb3JzXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCB0aGlzLmRiQ2xpZW50LnB1dEl0ZW0obWV0YWRhdGEgYXMgUmVjb3JkPHN0cmluZywgYW55PilcclxuICAgICAgcmV0dXJuIG1ldGFkYXRhXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBNZXRhZGF0YUVycm9yKSB7XHJcbiAgICAgICAgdGhyb3cgZXJyb3JcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnRmFpbGVkIHRvIGNyZWF0ZSBmaWxlIG1ldGFkYXRhJyxcclxuICAgICAgICBFcnJvckNvZGVzLkRBVEFCQVNFX0VSUk9SLFxyXG4gICAgICAgIDUwMCxcclxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcclxuICAgICAgKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RmlsZU1ldGFkYXRhKGZpbGVJZDogc3RyaW5nKTogUHJvbWlzZTxGaWxlTWV0YWRhdGEgfCBudWxsPiB7XHJcbiAgICBpZiAoIXRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRmlsZUlkKGZpbGVJZCkpIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ludmFsaWQgZmlsZSBJRCBmb3JtYXQnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgW3sgZmllbGQ6ICdmaWxlX2lkJywgbWVzc2FnZTogJ011c3QgYmUgYSB2YWxpZCBVVUlEIHY0JywgY29kZTogJ0lOVkFMSURfVVVJRCcgfV1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGJDbGllbnQuZ2V0SXRlbSh7IGZpbGVfaWQ6IGZpbGVJZCB9KVxyXG5cclxuICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm4gbnVsbFxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gcmVzdWx0IGFzIEZpbGVNZXRhZGF0YVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTWV0YWRhdGFFcnJvcikge1xyXG4gICAgICAgIHRocm93IGVycm9yXHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ZhaWxlZCB0byByZXRyaWV2ZSBmaWxlIG1ldGFkYXRhJyxcclxuICAgICAgICBFcnJvckNvZGVzLkRBVEFCQVNFX0VSUk9SLFxyXG4gICAgICAgIDUwMCxcclxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcclxuICAgICAgKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgdXBkYXRlRmlsZU1ldGFkYXRhKFxyXG4gICAgZmlsZUlkOiBzdHJpbmcsXHJcbiAgICB1cGRhdGVzOiBQYXJ0aWFsPEZpbGVNZXRhZGF0YT5cclxuICApOiBQcm9taXNlPEZpbGVNZXRhZGF0YT4ge1xyXG4gICAgaWYgKCF0aGlzLnZhbGlkYXRvci52YWxpZGF0ZUZpbGVJZChmaWxlSWQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdJbnZhbGlkIGZpbGUgSUQgZm9ybWF0JyxcclxuICAgICAgICBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIFt7IGZpZWxkOiAnZmlsZV9pZCcsIG1lc3NhZ2U6ICdNdXN0IGJlIGEgdmFsaWQgVVVJRCB2NCcsIGNvZGU6ICdJTlZBTElEX1VVSUQnIH1dXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gdGhpcy52YWxpZGF0b3IudmFsaWRhdGVVcGRhdGUodXBkYXRlcylcclxuICAgIGlmICghdmFsaWRhdGlvblJlc3VsdC5pc1ZhbGlkKSB7XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdWYWxpZGF0aW9uIGZhaWxlZCBmb3IgZmlsZSBtZXRhZGF0YSB1cGRhdGUnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgdmFsaWRhdGlvblJlc3VsdC5lcnJvcnNcclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5nZXRGaWxlTWV0YWRhdGEoZmlsZUlkKVxyXG4gICAgICBpZiAoIWV4aXN0aW5nKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgICAnRmlsZSBub3QgZm91bmQnLFxyXG4gICAgICAgICAgRXJyb3JDb2Rlcy5OT1RfRk9VTkQsXHJcbiAgICAgICAgICA0MDQsXHJcbiAgICAgICAgICBbeyBmaWVsZDogJ2ZpbGVfaWQnLCBtZXNzYWdlOiBgRmlsZSB3aXRoIElEICR7ZmlsZUlkfSBkb2VzIG5vdCBleGlzdGAsIGNvZGU6ICdOT1RfRk9VTkQnIH1dXHJcbiAgICAgICAgKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCB1cGRhdGVzV2l0aFRpbWVzdGFtcCA9IHtcclxuICAgICAgICAuLi51cGRhdGVzLFxyXG4gICAgICAgIHVwZGF0ZWRfYXQ6IERhdGUubm93KClcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgdXBkYXRlRXhwcmVzc2lvblBhcnRzOiBzdHJpbmdbXSA9IFtdXHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fVxyXG5cclxuICAgICAgT2JqZWN0LmVudHJpZXModXBkYXRlc1dpdGhUaW1lc3RhbXApLmZvckVhY2goKFtrZXksIHZhbHVlXSwgaW5kZXgpID0+IHtcclxuICAgICAgICBjb25zdCBuYW1lS2V5ID0gYCNhdHRyJHtpbmRleH1gXHJcbiAgICAgICAgY29uc3QgdmFsdWVLZXkgPSBgOnZhbCR7aW5kZXh9YFxyXG4gICAgICAgIHVwZGF0ZUV4cHJlc3Npb25QYXJ0cy5wdXNoKGAke25hbWVLZXl9ID0gJHt2YWx1ZUtleX1gKVxyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1tuYW1lS2V5XSA9IGtleVxyXG4gICAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbdmFsdWVLZXldID0gdmFsdWVcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb24gPSBgU0VUICR7dXBkYXRlRXhwcmVzc2lvblBhcnRzLmpvaW4oJywgJyl9YFxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYkNsaWVudC51cGRhdGVJdGVtKFxyXG4gICAgICAgIHsgZmlsZV9pZDogZmlsZUlkIH0sXHJcbiAgICAgICAgdXBkYXRlRXhwcmVzc2lvbixcclxuICAgICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1xyXG4gICAgICApXHJcblxyXG4gICAgICByZXR1cm4gcmVzdWx0IGFzIEZpbGVNZXRhZGF0YVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTWV0YWRhdGFFcnJvcikge1xyXG4gICAgICAgIHRocm93IGVycm9yXHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ZhaWxlZCB0byB1cGRhdGUgZmlsZSBtZXRhZGF0YScsXHJcbiAgICAgICAgRXJyb3JDb2Rlcy5EQVRBQkFTRV9FUlJPUixcclxuICAgICAgICA1MDAsXHJcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogdW5kZWZpbmVkXHJcbiAgICAgIClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZUFuYWx5c2lzU3RhdHVzKGZpbGVJZDogc3RyaW5nLCBzdGF0dXM6IEFuYWx5c2lzU3RhdHVzKTogUHJvbWlzZTxGaWxlTWV0YWRhdGE+IHtcclxuICAgIHJldHVybiB0aGlzLnVwZGF0ZUZpbGVNZXRhZGF0YShmaWxlSWQsIHtcclxuICAgICAgYW5hbHlzaXNfc3RhdHVzOiBzdGF0dXMsXHJcbiAgICAgIHVwZGF0ZWRfYXQ6IERhdGUubm93KClcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWxldGVGaWxlTWV0YWRhdGEoZmlsZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRmlsZUlkKGZpbGVJZCkpIHtcclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ludmFsaWQgZmlsZSBJRCBmb3JtYXQnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICA0MDAsXHJcbiAgICAgICAgW3sgZmllbGQ6ICdmaWxlX2lkJywgbWVzc2FnZTogJ011c3QgYmUgYSB2YWxpZCBVVUlEIHY0JywgY29kZTogJ0lOVkFMSURfVVVJRCcgfV1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIGlmICghdXNlcklkIHx8IHVzZXJJZC50cmltKCkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdVc2VyIElEIGlzIHJlcXVpcmVkJyxcclxuICAgICAgICBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIFt7IGZpZWxkOiAndXNlcl9pZCcsIG1lc3NhZ2U6ICdVc2VyIElEIGNhbm5vdCBiZSBlbXB0eScsIGNvZGU6ICdSRVFVSVJFRF9GSUVMRCcgfV1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5nZXRGaWxlTWV0YWRhdGEoZmlsZUlkKVxyXG4gICAgICBpZiAoIWV4aXN0aW5nKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgICAnRmlsZSBub3QgZm91bmQnLFxyXG4gICAgICAgICAgRXJyb3JDb2Rlcy5OT1RfRk9VTkQsXHJcbiAgICAgICAgICA0MDQsXHJcbiAgICAgICAgICBbeyBmaWVsZDogJ2ZpbGVfaWQnLCBtZXNzYWdlOiBgRmlsZSB3aXRoIElEICR7ZmlsZUlkfSBkb2VzIG5vdCBleGlzdGAsIGNvZGU6ICdOT1RfRk9VTkQnIH1dXHJcbiAgICAgICAgKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoZXhpc3RpbmcudXNlcl9pZCAhPT0gdXNlcklkKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgICAnVW5hdXRob3JpemVkOiBVc2VyIGRvZXMgbm90IG93biB0aGlzIGZpbGUnLFxyXG4gICAgICAgICAgRXJyb3JDb2Rlcy5VTkFVVEhPUklaRUQsXHJcbiAgICAgICAgICA0MDMsXHJcbiAgICAgICAgICBbeyBmaWVsZDogJ3VzZXJfaWQnLCBtZXNzYWdlOiAnQ2Fubm90IGRlbGV0ZSBmaWxlcyBvd25lZCBieSBvdGhlciB1c2VycycsIGNvZGU6ICdVTkFVVEhPUklaRUQnIH1dXHJcbiAgICAgICAgKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBhd2FpdCB0aGlzLmRiQ2xpZW50LmRlbGV0ZUl0ZW0oeyBmaWxlX2lkOiBmaWxlSWQgfSlcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE1ldGFkYXRhRXJyb3IpIHtcclxuICAgICAgICB0aHJvdyBlcnJvclxyXG4gICAgICB9XHJcbiAgICAgIHRocm93IG5ldyBNZXRhZGF0YUVycm9yKFxyXG4gICAgICAgICdGYWlsZWQgdG8gZGVsZXRlIGZpbGUgbWV0YWRhdGEnLFxyXG4gICAgICAgIEVycm9yQ29kZXMuREFUQUJBU0VfRVJST1IsXHJcbiAgICAgICAgNTAwLFxyXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IHVuZGVmaW5lZFxyXG4gICAgICApXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRVc2VyRmlsZXMoXHJcbiAgICBfdXNlcklkOiBzdHJpbmcsXHJcbiAgICBfcGFnaW5hdGlvbj86IFBhZ2luYXRpb25PcHRpb25zXHJcbiAgKTogUHJvbWlzZTxQYWdpbmF0ZWRSZXN1bHQ8RmlsZU1ldGFkYXRhPj4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgaW1wbGVtZW50ZWQgeWV0IC0gd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiBUYXNrIDcuMScpXHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRGaWxlc0J5U3RhdHVzKFxyXG4gICAgX3N0YXR1czogQW5hbHlzaXNTdGF0dXMsXHJcbiAgICBfcGFnaW5hdGlvbj86IFBhZ2luYXRpb25PcHRpb25zXHJcbiAgKTogUHJvbWlzZTxQYWdpbmF0ZWRSZXN1bHQ8RmlsZU1ldGFkYXRhPj4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgaW1wbGVtZW50ZWQgeWV0IC0gd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiBUYXNrIDcuMycpXHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRVc2VyRmlsZXNCeVN0YXR1cyhcclxuICAgIF91c2VySWQ6IHN0cmluZyxcclxuICAgIF9zdGF0dXM6IEFuYWx5c2lzU3RhdHVzXHJcbiAgKTogUHJvbWlzZTxGaWxlTWV0YWRhdGFbXT4ge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgaW1wbGVtZW50ZWQgeWV0IC0gd2lsbCBiZSBpbXBsZW1lbnRlZCBpbiBUYXNrIDcuNCcpXHJcbiAgfVxyXG5cclxuICBhc3luYyBiYXRjaEdldEZpbGVzKGZpbGVJZHM6IHN0cmluZ1tdKTogUHJvbWlzZTxGaWxlTWV0YWRhdGFbXT4ge1xyXG4gICAgaWYgKCFmaWxlSWRzIHx8IGZpbGVJZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBbXVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGludmFsaWRJZHMgPSBmaWxlSWRzLmZpbHRlcihpZCA9PiAhdGhpcy52YWxpZGF0b3IudmFsaWRhdGVGaWxlSWQoaWQpKVxyXG4gICAgaWYgKGludmFsaWRJZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgTWV0YWRhdGFFcnJvcihcclxuICAgICAgICAnSW52YWxpZCBmaWxlIElEIGZvcm1hdCBpbiBiYXRjaCByZXF1ZXN0JyxcclxuICAgICAgICBFcnJvckNvZGVzLlZBTElEQVRJT05fRVJST1IsXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIGludmFsaWRJZHMubWFwKGlkID0+ICh7IFxyXG4gICAgICAgICAgZmllbGQ6ICdmaWxlX2lkJywgXHJcbiAgICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBVVUlEOiAke2lkfWAsIFxyXG4gICAgICAgICAgY29kZTogJ0lOVkFMSURfVVVJRCcgXHJcbiAgICAgICAgfSkpXHJcbiAgICAgIClcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBrZXlzID0gZmlsZUlkcy5tYXAoZmlsZUlkID0+ICh7IGZpbGVfaWQ6IGZpbGVJZCB9KSlcclxuICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHRoaXMuZGJDbGllbnQuYmF0Y2hHZXRJdGVtcyhrZXlzKVxyXG4gICAgICByZXR1cm4gcmVzdWx0cyBhcyBGaWxlTWV0YWRhdGFbXVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgTWV0YWRhdGFFcnJvcikge1xyXG4gICAgICAgIHRocm93IGVycm9yXHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgbmV3IE1ldGFkYXRhRXJyb3IoXHJcbiAgICAgICAgJ0ZhaWxlZCB0byBiYXRjaCByZXRyaWV2ZSBmaWxlIG1ldGFkYXRhJyxcclxuICAgICAgICBFcnJvckNvZGVzLkRBVEFCQVNFX0VSUk9SLFxyXG4gICAgICAgIDUwMCxcclxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiB1bmRlZmluZWRcclxuICAgICAgKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgYmF0Y2hEZWxldGVGaWxlcyhfZmlsZUlkczogc3RyaW5nW10sIF91c2VySWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nW10+IHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkIHlldCAtIHdpbGwgYmUgaW1wbGVtZW50ZWQgaW4gVGFzayA2LjMnKVxyXG4gIH1cclxufVxyXG4iXX0=