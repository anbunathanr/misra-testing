"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestCaseService = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const uuid_1 = require("uuid");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const TABLE_NAME = process.env.TEST_CASES_TABLE_NAME || 'TestCases';
class TestCaseService {
    async createTestCase(userId, input) {
        const now = Math.floor(Date.now() / 1000);
        const testCase = {
            testCaseId: (0, uuid_1.v4)(),
            suiteId: input.suiteId,
            projectId: input.projectId,
            userId,
            name: input.name,
            description: input.description,
            type: input.type,
            steps: input.steps,
            priority: input.priority || 'medium',
            tags: input.tags || [],
            createdAt: now,
            updatedAt: now,
        };
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: TABLE_NAME,
            Item: testCase,
        }));
        return testCase;
    }
    async getTestCase(testCaseId) {
        const result = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: TABLE_NAME,
            Key: { testCaseId },
        }));
        return result.Item || null;
    }
    async getSuiteTestCases(suiteId) {
        const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            IndexName: 'SuiteIndex',
            KeyConditionExpression: 'suiteId = :suiteId',
            ExpressionAttributeValues: {
                ':suiteId': suiteId,
            },
        }));
        return result.Items || [];
    }
    async getProjectTestCases(projectId) {
        const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: TABLE_NAME,
            IndexName: 'ProjectIndex',
            KeyConditionExpression: 'projectId = :projectId',
            ExpressionAttributeValues: {
                ':projectId': projectId,
            },
        }));
        return result.Items || [];
    }
    async updateTestCase(input) {
        const now = Math.floor(Date.now() / 1000);
        const updateExpressions = [];
        const expressionAttributeNames = {};
        const expressionAttributeValues = {};
        if (input.name) {
            updateExpressions.push('#name = :name');
            expressionAttributeNames['#name'] = 'name';
            expressionAttributeValues[':name'] = input.name;
        }
        if (input.description) {
            updateExpressions.push('#description = :description');
            expressionAttributeNames['#description'] = 'description';
            expressionAttributeValues[':description'] = input.description;
        }
        if (input.type) {
            updateExpressions.push('#type = :type');
            expressionAttributeNames['#type'] = 'type';
            expressionAttributeValues[':type'] = input.type;
        }
        if (input.steps) {
            updateExpressions.push('#steps = :steps');
            expressionAttributeNames['#steps'] = 'steps';
            expressionAttributeValues[':steps'] = input.steps;
        }
        if (input.priority) {
            updateExpressions.push('#priority = :priority');
            expressionAttributeNames['#priority'] = 'priority';
            expressionAttributeValues[':priority'] = input.priority;
        }
        if (input.tags) {
            updateExpressions.push('#tags = :tags');
            expressionAttributeNames['#tags'] = 'tags';
            expressionAttributeValues[':tags'] = input.tags;
        }
        updateExpressions.push('#updatedAt = :updatedAt');
        expressionAttributeNames['#updatedAt'] = 'updatedAt';
        expressionAttributeValues[':updatedAt'] = now;
        const result = await docClient.send(new lib_dynamodb_1.UpdateCommand({
            TableName: TABLE_NAME,
            Key: { testCaseId: input.testCaseId },
            UpdateExpression: `SET ${updateExpressions.join(', ')}`,
            ExpressionAttributeNames: expressionAttributeNames,
            ExpressionAttributeValues: expressionAttributeValues,
            ReturnValues: 'ALL_NEW',
        }));
        return result.Attributes;
    }
    async deleteTestCase(testCaseId) {
        await docClient.send(new lib_dynamodb_1.UpdateCommand({
            TableName: TABLE_NAME,
            Key: { testCaseId },
            UpdateExpression: 'SET #deleted = :deleted, #updatedAt = :updatedAt',
            ExpressionAttributeNames: {
                '#deleted': 'deleted',
                '#updatedAt': 'updatedAt',
            },
            ExpressionAttributeValues: {
                ':deleted': true,
                ':updatedAt': Math.floor(Date.now() / 1000),
            },
        }));
    }
}
exports.TestCaseService = TestCaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1jYXNlLXNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LWNhc2Utc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBMEQ7QUFDMUQsd0RBQW9IO0FBRXBILCtCQUFvQztBQUVwQyxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRXRELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksV0FBVyxDQUFDO0FBRXBFLE1BQWEsZUFBZTtJQUMxQixLQUFLLENBQUMsY0FBYyxDQUFDLE1BQWMsRUFBRSxLQUEwQjtRQUM3RCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLFFBQVEsR0FBYTtZQUN6QixVQUFVLEVBQUUsSUFBQSxTQUFNLEdBQUU7WUFDcEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1lBQ3RCLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixNQUFNO1lBQ04sSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQ2hCLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVztZQUM5QixJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUk7WUFDaEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO1lBQ2xCLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUSxJQUFJLFFBQVE7WUFDcEMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRTtZQUN0QixTQUFTLEVBQUUsR0FBRztZQUNkLFNBQVMsRUFBRSxHQUFHO1NBQ2YsQ0FBQztRQUVGLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FDbEIsSUFBSSx5QkFBVSxDQUFDO1lB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Q0FBQyxJQUFJLENBQ2xCLElBQUksNEJBQWEsQ0FBQztZQUNoQixTQUFTLEVBQUUsVUFBVTtZQUNyQixHQUFHLEVBQUUsRUFBRSxVQUFVLEVBQUU7WUFDbkIsZ0JBQWdCLEVBQUUsa0RBQWtEO1lBQ3BFLHdCQUF3QixFQUFFO2dCQUN4QixVQUFVLEVBQUUsU0FBUztnQkFDckIsWUFBWSxFQUFFLFdBQVc7YUFDMUI7WUFDRCx5QkFBeUIsRUFBRTtnQkFDekIsVUFBVSxFQUFFLElBQUk7Z0JBQ2hCLFlBQVksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7YUFDNUM7U0FDRixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQW5KRCwwQ0FtSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFB1dENvbW1hbmQsIEdldENvbW1hbmQsIFF1ZXJ5Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XHJcbmltcG9ydCB7IFRlc3RDYXNlLCBDcmVhdGVUZXN0Q2FzZUlucHV0LCBVcGRhdGVUZXN0Q2FzZUlucHV0IH0gZnJvbSAnLi4vdHlwZXMvdGVzdC1jYXNlJztcclxuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XHJcblxyXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xyXG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oY2xpZW50KTtcclxuXHJcbmNvbnN0IFRBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5URVNUX0NBU0VTX1RBQkxFX05BTUUgfHwgJ1Rlc3RDYXNlcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgVGVzdENhc2VTZXJ2aWNlIHtcclxuICBhc3luYyBjcmVhdGVUZXN0Q2FzZSh1c2VySWQ6IHN0cmluZywgaW5wdXQ6IENyZWF0ZVRlc3RDYXNlSW5wdXQpOiBQcm9taXNlPFRlc3RDYXNlPiB7XHJcbiAgICBjb25zdCBub3cgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKTtcclxuICAgIGNvbnN0IHRlc3RDYXNlOiBUZXN0Q2FzZSA9IHtcclxuICAgICAgdGVzdENhc2VJZDogdXVpZHY0KCksXHJcbiAgICAgIHN1aXRlSWQ6IGlucHV0LnN1aXRlSWQsXHJcbiAgICAgIHByb2plY3RJZDogaW5wdXQucHJvamVjdElkLFxyXG4gICAgICB1c2VySWQsXHJcbiAgICAgIG5hbWU6IGlucHV0Lm5hbWUsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiBpbnB1dC5kZXNjcmlwdGlvbixcclxuICAgICAgdHlwZTogaW5wdXQudHlwZSxcclxuICAgICAgc3RlcHM6IGlucHV0LnN0ZXBzLFxyXG4gICAgICBwcmlvcml0eTogaW5wdXQucHJpb3JpdHkgfHwgJ21lZGl1bScsXHJcbiAgICAgIHRhZ3M6IGlucHV0LnRhZ3MgfHwgW10sXHJcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxyXG4gICAgICB1cGRhdGVkQXQ6IG5vdyxcclxuICAgIH07XHJcblxyXG4gICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoXHJcbiAgICAgIG5ldyBQdXRDb21tYW5kKHtcclxuICAgICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXHJcbiAgICAgICAgSXRlbTogdGVzdENhc2UsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiB0ZXN0Q2FzZTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFRlc3RDYXNlKHRlc3RDYXNlSWQ6IHN0cmluZyk6IFByb21pc2U8VGVzdENhc2UgfCBudWxsPiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcclxuICAgICAgbmV3IEdldENvbW1hbmQoe1xyXG4gICAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcclxuICAgICAgICBLZXk6IHsgdGVzdENhc2VJZCB9LFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gKHJlc3VsdC5JdGVtIGFzIFRlc3RDYXNlKSB8fCBudWxsO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U3VpdGVUZXN0Q2FzZXMoc3VpdGVJZDogc3RyaW5nKTogUHJvbWlzZTxUZXN0Q2FzZVtdPiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcclxuICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XHJcbiAgICAgICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxyXG4gICAgICAgIEluZGV4TmFtZTogJ1N1aXRlSW5kZXgnLFxyXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdzdWl0ZUlkID0gOnN1aXRlSWQnLFxyXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAgICc6c3VpdGVJZCc6IHN1aXRlSWQsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIChyZXN1bHQuSXRlbXMgYXMgVGVzdENhc2VbXSkgfHwgW107XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRQcm9qZWN0VGVzdENhc2VzKHByb2plY3RJZDogc3RyaW5nKTogUHJvbWlzZTxUZXN0Q2FzZVtdPiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcclxuICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XHJcbiAgICAgICAgVGFibGVOYW1lOiBUQUJMRV9OQU1FLFxyXG4gICAgICAgIEluZGV4TmFtZTogJ1Byb2plY3RJbmRleCcsXHJcbiAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3Byb2plY3RJZCA9IDpwcm9qZWN0SWQnLFxyXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAgICc6cHJvamVjdElkJzogcHJvamVjdElkLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiAocmVzdWx0Lkl0ZW1zIGFzIFRlc3RDYXNlW10pIHx8IFtdO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgdXBkYXRlVGVzdENhc2UoaW5wdXQ6IFVwZGF0ZVRlc3RDYXNlSW5wdXQpOiBQcm9taXNlPFRlc3RDYXNlPiB7XHJcbiAgICBjb25zdCBub3cgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKTtcclxuICAgIFxyXG4gICAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcclxuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcclxuXHJcbiAgICBpZiAoaW5wdXQubmFtZSkge1xyXG4gICAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjbmFtZSA9IDpuYW1lJyk7XHJcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI25hbWUnXSA9ICduYW1lJztcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOm5hbWUnXSA9IGlucHV0Lm5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGlucHV0LmRlc2NyaXB0aW9uKSB7XHJcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goJyNkZXNjcmlwdGlvbiA9IDpkZXNjcmlwdGlvbicpO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNkZXNjcmlwdGlvbiddID0gJ2Rlc2NyaXB0aW9uJztcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmRlc2NyaXB0aW9uJ10gPSBpbnB1dC5kZXNjcmlwdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoaW5wdXQudHlwZSkge1xyXG4gICAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjdHlwZSA9IDp0eXBlJyk7XHJcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3R5cGUnXSA9ICd0eXBlJztcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnR5cGUnXSA9IGlucHV0LnR5cGU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGlucHV0LnN0ZXBzKSB7XHJcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goJyNzdGVwcyA9IDpzdGVwcycpO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNbJyNzdGVwcyddID0gJ3N0ZXBzJztcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0ZXBzJ10gPSBpbnB1dC5zdGVwcztcclxuICAgIH1cclxuXHJcbiAgICBpZiAoaW5wdXQucHJpb3JpdHkpIHtcclxuICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnI3ByaW9yaXR5ID0gOnByaW9yaXR5Jyk7XHJcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3ByaW9yaXR5J10gPSAncHJpb3JpdHknO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6cHJpb3JpdHknXSA9IGlucHV0LnByaW9yaXR5O1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChpbnB1dC50YWdzKSB7XHJcbiAgICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goJyN0YWdzID0gOnRhZ3MnKTtcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzWycjdGFncyddID0gJ3RhZ3MnO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6dGFncyddID0gaW5wdXQudGFncztcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjdXBkYXRlZEF0ID0gOnVwZGF0ZWRBdCcpO1xyXG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzWycjdXBkYXRlZEF0J10gPSAndXBkYXRlZEF0JztcclxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzp1cGRhdGVkQXQnXSA9IG5vdztcclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChcclxuICAgICAgbmV3IFVwZGF0ZUNvbW1hbmQoe1xyXG4gICAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcclxuICAgICAgICBLZXk6IHsgdGVzdENhc2VJZDogaW5wdXQudGVzdENhc2VJZCB9LFxyXG4gICAgICAgIFVwZGF0ZUV4cHJlc3Npb246IGBTRVQgJHt1cGRhdGVFeHByZXNzaW9ucy5qb2luKCcsICcpfWAsXHJcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXHJcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcclxuICAgICAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJyxcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdC5BdHRyaWJ1dGVzIGFzIFRlc3RDYXNlO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsZXRlVGVzdENhc2UodGVzdENhc2VJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChcclxuICAgICAgbmV3IFVwZGF0ZUNvbW1hbmQoe1xyXG4gICAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcclxuICAgICAgICBLZXk6IHsgdGVzdENhc2VJZCB9LFxyXG4gICAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgI2RlbGV0ZWQgPSA6ZGVsZXRlZCwgI3VwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnLFxyXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xyXG4gICAgICAgICAgJyNkZWxldGVkJzogJ2RlbGV0ZWQnLFxyXG4gICAgICAgICAgJyN1cGRhdGVkQXQnOiAndXBkYXRlZEF0JyxcclxuICAgICAgICB9LFxyXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAgICc6ZGVsZXRlZCc6IHRydWUsXHJcbiAgICAgICAgICAnOnVwZGF0ZWRBdCc6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=